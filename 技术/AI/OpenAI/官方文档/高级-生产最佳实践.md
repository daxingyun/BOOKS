## 高级-生产最佳实践
本指南提供了一套全面的最佳实践，可帮助您从原型过渡到生产。无论您是经验丰富的机器学习工程师还是新近的爱好者，本指南都将为您提供成功将平台投入生产环境所需的工具：从保护对我们 API 的访问到设计能够处理高交通量。使用本指南来帮助制定尽可能顺利有效地部署应用程序的计划。
### 设置您的组织
[登录](https://beta.openai.com/login) 到您的 OpenAI 帐户后，您可以在您的[组织设置](https://beta.openai.com/account/org-settings)中找到您的组织名称和 ID 。组织名称是您的组织的标签，显示在用户界面中。组织 ID 是您组织的唯一标识符，可用于 API 请求。

属于多个组织的用户可以通过[标签](https://beta.openai.com/docs/api-reference/requesting-organization)来指定哪个组织用于 API 请求。来自这些 API 请求的使用将计入指定组织的配额。如果未提供标签，将按[默认组织计费](https://beta.openai.com/account/api-keys)。您可以在用户设置中更改默认组织。

您可以从[成员设置](https://beta.openai.com/account/members)页面邀请新成员加入您的组织。成员可以是读者或所有者。读者可以进行 API 请求和查看基本组织信息，而所有者可以修改帐单信息和管理组织内的成员。
### 管理计费限额
新的免费试用用户将获得 18 美元的初始信用额度，三个月后到期。信用额度用完或过期后，您可以选择输入账单信息以继续使用 API。如果未输入[账单信息](https://beta.openai.com/account/billing/overview)，您仍然可以登录，但无法再发出任何 API 请求。

输入账单信息后，您将获得每月 120 美元的批准使用限额，这是由 OpenAI 设定的。要将您的配额增加到超过 120 美元的每月账单限额，请提交[配额增加请求](https://beta.openai.com/forms/quota-increase)。

如果您希望在使用量超过一定数量时收到通知，您可以通过[使用限制](https://beta.openai.com/account/billing/limits)页面设置软限制。当达到软限制时，组织的所有者将收到一封电子邮件通知。您还可以设置硬限制，一旦达到硬限制，任何后续 API 请求都将被拒绝。请注意，这些限制是尽力而为的，使用和执行限制之间可能会有 5 到 10 分钟的延迟。
### API密钥
OpenAI API 使用 API 密钥进行身份验证。访问您的 [API 密钥](https://beta.openai.com/account/api-keys)页面以检索您将在请求中使用的 API 密钥。

这是控制访问的一种相对直接的方法，但您必须警惕保护这些密钥。避免在您的代码或公共存储库中公开 API 密钥；相反，将它们存储在安全的位置。您应该使用环境变量或秘密管理服务将您的密钥公开给您的应用程序，这样您就不需要在代码库中对它们进行硬编码。在我们的 API [密钥安全最佳实践](https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety)中阅读更多内容。
### 暂存帐户
随着规模的扩大，您可能希望为暂存和生产环境创建单独的组织。请注意，您可以使用两个单独的电子邮件地址（例如 `bob+prod@widgetcorp.com` 和`bob+dev@widgetcorp.com`）进行注册，以创建两个组织。这将允许您隔离您的开发和测试工作，这样您就不会意外地中断您的实时应用程序。您还可以通过这种方式限制对生产组织的访问。
### 建立你的原型
如果您还没有阅读[快速入门指南](https://beta.openai.com/docs/quickstart)，我们建议您先从这里开始，然后再深入阅读本指南的其余部分。

对于 OpenAI API 的新手，我们的 [playground](https://beta.openai.com/playground) 可以成为探索其功能的重要资源。这样做将帮助您了解什么是可能的，以及您可能希望将精力集中在哪些方面。您还可以浏览我们的 [示例提示](https://beta.openai.com/examples)。

虽然游乐场是制作原型的好地方，但它也可以用作大型项目的孵化区。playground 还可以轻松导出 API 请求的代码片段并与协作者共享提示，使其成为开发过程中不可或缺的一部分。
#### 附加提示
1. 首先确定

	您希望应用程序具有的核心功能。考虑您将需要的数据输入、输出和处理的类型。旨在使原型尽可能集中，以便您可以快速高效地进行迭代。
2. 选择您感觉最舒服并且最符合您的项目目标的编程语言和框架。

	一些流行的选项包括 Python、Java 和 Node.js。请参阅[库支持](https://beta.openai.com/docs/libraries/community-libraries)页面以了解有关由我们的团队和更广泛的开发人员社区维护的库绑定的更多信息。
3. 开发环境和支持

	使用正确的工具和库设置您的开发环境，并确保您拥有训练模型所需的资源。利用我们的文档、[社区论坛](https://community.openai.com/)和我们的[帮助中心](https://help.openai.com/)获得故障排除方面的帮助。如果您使用 Python 进行开发，请查看此[结构化项目指南](https://docs.python-guide.org/writing/structure/)（存储库结构是项目架构的重要组成部分）。为了与我们的支持工程师联系，只需登录您的帐户并使用“帮助”按钮开始对话。
	
#### 提高提示可靠性的技术
即使进行了周密的计划，在您的应用程序中使用 GPT-3 时为意外问题做好准备也很重要。在某些情况下，模型可能会在任务上失败，因此考虑可以采取哪些措施来提高应用程序的可靠性会很有帮助。

如果您的任务涉及逻辑推理或复杂性，您可能需要采取额外的步骤来构建更可靠的提示。如需一些有用的建议，请参阅我们的[提高可靠性的技术指南](https://github.com/openai/openai-cookbook/blob/main/techniques_to_improve_reliability.md)。总体而言，建议围绕：

1. 将不可靠的操作分解为更小、更可靠的操作（例如，选择推理提示）
2. 使用多个步骤或多个关系使系统的可靠性大于任何单个组件（例如，美化提示）

### 评估和迭代
开发生产系统最重要的方面之一是定期评估和迭代试验。此过程允许您衡量性能、解决问题并微调您的模型以提高准确性和效率。此过程的一个关键部分是为您的功能创建评估数据集。请记住以下几点：

1. 确保您的评估集代表您的模型将在现实世界中使用的数据。这将允许您评估您的模型在它以前从未见过的数据上的性能，并帮助您了解它对新情况的泛化能力。
2. 定期更新您的评估集，以确保它在您的模型发展和新数据可用时保持相关性。
3. 使用各种指标来评估模型的性能。根据您的应用程序和业务成果，这可能包括[准确度、精确度、召回率、F1 分数或平均精确度 (MAP)](https://scikit-learn.org/stable/modules/generated/sklearn.metrics.precision_recall_fscore_support.html)。此外，您可以将微调与权重和偏差同步以跟踪实验、模型和数据集。
4. 将模型的性能与基线进行比较。这将使您更好地了解模型的优势和劣势，并有助于指导您未来的开发工作。

通过进行定期评估和迭代实验，您可以确保您的 GPT 驱动的应用程序或原型随着时间的推移不断改进。

#### 评估语言模型
语言模型可能很难评估，因为评估生成语言的质量通常是主观的并且有许多不同的方法可以用语言正确传达相同的信息。例如，在评估一个模型对一大段文本的总结能力时，有很多正确的总结。话虽如此，设计良好的评估对于机器学习取得进展至关重要。

评估套件需要全面、易于运行且速度相当快（取决于模型大小）。它还需要易于继续添加到套件中，因为一个月的综合性内容可能在另一个月就已经过时了。我们应该优先考虑具有多样性的任务和任务，这些任务可以识别模型中的弱点或没有随着扩展而改进的能力。

评估系统的最简单方法是手动检查其输出。它在做你想做的事吗？输出质量高吗？他们一致吗？
#### 自动评估
加快测试速度的最佳方法是开发自动化评估。但是，这在摘要任务等更主观的应用程序中可能是不可能的。

当很容易将最终输出定为正确或不正确时，自动评估效果最佳。

	例如，如果您正在微调分类器以将文本字符串分类为 A 类或 B 类，这非常简单：创建一个包含示例输入和输出对的测试集，在输入上运行您的系统，然后对系统进行评分输出与正确输出（查看准确度、F1 分数、交叉熵等指标）。

如果您的输出是半开放式的，就像会议记录总结器那样，那么定义成功可能会比较棘手：例如，是什么让一个总结比另一个更好？这里，可能的技术包括：

- 使用“黄金标准”答案编写测试，然后测量每个黄金标准答案与系统输出之间的某种相似性分数（我们已经看到嵌入为此工作得很好）
- 建立一个判别器系统来判断/排序输出，然后给判别器一组输出，其中一个由被测系统生成（这甚至可以是 GPT 模型，询问给定输出是否正确回答了问题）
- 建立一个评估模型，检查答案组成部分的真实性；例如，检测引号是否实际出现在给定文本中

对于非常开放的任务，例如创意故事作家，自动化评估更加困难。尽管可以制定质量指标来查看拼写错误、单词多样性和可读性分数，但这些指标并不能真正反映一篇文章的创造性质量。在找不到好的自动化指标的情况下，人工评估仍然是最好的方法。

#### 评估基于 GPT-3 的系统的示例程序
作为示例，让我们考虑构建基于检索的问答系统的情况。

基于检索的问答系统有两个步骤。

- 首先，用户的查询用于对知识库中可能相关的文档进行排名。
- 其次，GPT-3 获得了排名靠前的文档，并被要求生成查询的答案。

可以进行评估以衡量每个步骤的性能。

对于搜索步骤，可以：

- 首先，生成一个包含约 100 个问题的测试集和每个问题的一组正确文档
	- 如果您有任何问题，可以从用户数据中获取问题；否则，您可以发明一组具有不同风格和难度的问题。
	- 对于每个问题，让一个人手动搜索知识库并记录包含答案的文档集。
- 其次，使用测试集对系统的性能进行评分
	- 对于每个问题，使用系统对候选文档进行排名（例如，通过文档嵌入与查询嵌入的余弦相似度）。
	- 如果候选文档至少包含 1 个来自答案键的相关文档，则可以使用二进制准确度分数 1 对结果进行评分，否则为 0
	- 您还可以使用 Mean Reciprocal Rank 等连续指标，它可以帮助区分接近正确或远非正确的答案（例如，如果正确的文档排名第 1，则得分为 1，如果排名第 2，则得分为 ½ , ⅓ 如果排名 3, 等等)

对于问题回答步骤，可以：

- 首先，生成一个包含约 100 组{question, relevant text, correct answer} 的测试集
	- 对于问题和相关文本，使用上面的数据
	- 对于正确的答案，让一个人写下大约 100 个好的答案的例子。
- 其次，使用测试集对系统的性能进行评分
	- 对于每个问题和文本对，将它们组合成一个提示并将提示提交给 GPT-3
	- 接下来，将 GPT-3 的答案与人类编写的黄金标准答案进行比较
		- 这种比较可以是手动的，人类将它们并排查看并对 GPT-3 答案是否正确/高质量进行评分
		- 这种比较也可以通过使用嵌入相似性分数或其他方法来自动化（自动化方法可能会有噪音，但噪音是可以的，只要它是无偏见的，并且在你正在相互测试的不同类型的模型之间同样有噪音）

当然， `N=100` 这只是一个例子，在早期阶段，您可能会从更容易生成的较小集合开始，而在后期阶段，您可能会投资成本更高但在统计上更可靠的更大集合。

### 扩展您的解决方案架构
在设计使用我们的 API 用于生产的应用程序或服务时，重要的是要考虑如何扩展以满足流量需求。无论您选择哪种云服务提供商，您都需要考虑几个关键领域：

- 水平扩展

	您可能希望水平扩展您的应用程序以适应来自多个来源的应用程序请求。这可能涉及部署额外的服务器或容器来分配负载。如果您选择这种类型的缩放，请确保您的体系结构设计用于处理多个节点，并且您有适当的机制来平衡它们之间的负载。
- 垂直扩展

	另一种选择是垂直扩展您的应用程序，这意味着您可以增加单个节点可用的资源。这将涉及升级服务器的能力以处理额外的负载。如果您选择这种类型的扩展，请确保您的应用程序旨在利用这些额外资源。
- 缓存

	通过存储经常访问的数据，您可以缩短响应时间，而无需重复调用我们的 API。您的应用程序需要设计为尽可能使用缓存数据，并在添加新信息时使缓存无效。有几种不同的方法可以做到这一点。例如，您可以将数据存储在数据库、文件系统或内存缓存中，具体取决于哪种方式对您的应用程序最有意义。
- 负载均衡

	最后，考虑负载均衡技术以确保请求在可用服务器之间均匀分布。这可能涉及在服务器前面使用负载均衡器或使用 DNS 循环。负载均衡将有助于提高性能并减少瓶颈。

### 管理速率限制和延迟
使用我们的 API 时，了解和规划[速率限制](https://help.openai.com/en/articles/5955598-is-api-usage-subject-to-any-rate-limits)非常重要。超过这些限制将导致错误消息并可能破坏应用程序的性能。速率限制出于多种原因，从防止滥用到确保每个人都能公平地访问 API。

为避免遇到它们，请记住以下提示：

- 监控您的 API 使用情况以保持在您的速率限制阈值内。考虑实施指数退避和重试逻辑，以便您的应用程序可以在达到速率限制时暂停并重试请求。（见下面的例子）。
- 使用缓存策略来减少应用程序需要发出的请求数。
- 如果您的应用程序始终遇到速率限制，您可能需要调整您的架构或策略以以要求较低的方式使用 API。

为避免达到速率限制，我们通常建议对您的请求代码实施指数退避。如需其他提示和指导，请参阅我们的[如何处理速率限制指南](https://github.com/openai/openai-cookbook/blob/main/examples/How_to_handle_rate_limits.ipynb)。在 Python 中，指数退避解决方案可能如下所示：


	import backoff
	import openai
	from openai.error import RateLimitError
	
	@backoff.on_exception(backoff.expo, RateLimitError)
	def completions_with_backoff(**kwargs):
	    response = openai.Completion.create(**kwargs)
	    return response
（请注意：退避库是第三方工具。我们鼓励所有用户在验证其项目的任何外部代码时进行尽职调查。）

正如[食谱](https://github.com/openai/openai-cookbook/blob/main/examples/How_to_handle_rate_limits.ipynb)中所述，如果您正在处理来自用户的实时请求，退避和重试是一个很好的策略，可以最大限度地减少延迟，同时避免速率限制错误。但是，如果您正在处理大量批处理数据，其中吞吐量比延迟更重要，那么除了退避和重试之外，您还可以做一些其他事情，例如，主动添加请求和批处理请求之间的延迟。请注意，我们的 API 对每分钟的请求数和每分钟的 token 数有单独的限制。

### 管理成本
要监控您的成本，您可以在您的帐户中设置一个软限制，以便在您超过某个使用阈值时收到一封电子邮件警报。您还可以设置硬限制。请注意硬限制可能会导致您的应用程序/用户中断。使用使用情况跟踪仪表板来监控您在当前和过去的计费周期中的 token 使用情况。
#### 文本生成
将原型投入生产的挑战之一是对与运行应用程序相关的成本进行预算。OpenAI 提供现[收现付的定价模型](https://openai.com/api/pricing/)，每 1,000 个代币（约等于 750 个单词）的价格。要估算您的成本，您需要预测代币利用率。考虑诸如流量级别、用户与您的应用程序交互的频率以及您将处理的数据量等因素。

`考虑降低成本的一个有用框架是将成本视为代币数量和每个代币成本的函数`。使用此框架可以通过两种潜在途径降低成本。

- 首先，您可以通过为某些任务切换到较小的模型来降低每个 token 的成本，以降全局低成本。
- 或者，您可以尝试减少所需的 token 数量。

	有几种方法可以做到这一点，例如使用更短的提示、[微调](https://beta.openai.com/docs/guides/fine-tuning)模型或缓存常见的用户查询，这样就不需要重复处理它们。

您可以尝试使用我们的交互式[分词器](https://beta.openai.com/tokenizer)工具来帮助您估算成本。API 和 playground 还返回 token 计数作为响应的一部分。一旦您使用了我们最强大的模型，您就可以查看其他模型是否可以以更低的延迟和成本产生相同的结果。[在我们的 token 使用帮助文章](https://help.openai.com/en/articles/6614209-how-do-i-check-my-token-usage)中了解更多信息。

### MLOps 策略
当您将原型投入生产时，您可能需要考虑制定 MLOps 策略。MLOps（机器学习操作）是指管理机器学习模型的端到端生命周期的过程，包括您可能使用我们的 API 进行微调的任何模型。设计 MLOps 策略时需要考虑多个方面。这些包括

- 数据和模型管理

	管理用于训练或微调模型以及跟踪版本和更改的数据。
- 模型监控

	随着时间的推移跟踪模型的性能并检测任何潜在的问题或退化。
- 模型再训练

	确保您的模型与数据变化或不断变化的需求保持同步，并根据需要进行再训练或微调。
- 模型部署

	自动化将模型和相关工件部署到生产中的过程。

仔细考虑您的应用程序的这些方面将有助于确保您的模型保持相关性并随着时间的推移表现良好。

### 安全性和合规性
当您将原型投入生产时，您需要评估并解决可能适用于您的应用程序的任何安全性和合规性要求。这将涉及检查您正在处理的数据、了解我们的 API 如何处理数据，以及确定您必须遵守哪些法规。作为参考，这里是我们的[隐私政策](https://openai.com/privacy/)和[使用条款](https://openai.com/api/policies/terms/)。

您需要考虑的一些常见领域包括数据存储、数据传输和数据保留。您可能还需要实施数据隐私保护，例如在可能的情况下进行加密或匿名化。此外，您应该遵循安全编码的最佳实践，例如输入清理和正确的错误处理。

#### 安全最佳实践
使用我们的 API 创建您的应用程序时，请考虑我们的[安全最佳实践](https://beta.openai.com/docs/guides/safety-best-practices)，以确保您的应用程序安全且成功。这些建议强调了广泛测试产品、积极解决潜在问题以及限制滥用机会的重要性。
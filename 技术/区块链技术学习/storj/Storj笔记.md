# Storj 读书笔记
## 系统结构
系统结构分为两大体系

- 区块链(激励体系)
	- 以太坊代币体系 [ERC20](https://link.jianshu.com/?t=https%3A%2F%2Fgithub.com%2Fethereum%2FEIPs%2Fblob%2Fmaster%2FEIPS%2Feip-20-token-standard.md) 实现，主要使用它作为分布式存储的结算系统，用户的数据是不会写入区块链的，写入区块链是只有用户对代币的交易。
	- 流程(可能有错)
		- 客户获取 StorJ Token 存放在自己的账户中 
		- 客户通过卫星获取数据节点位置，并提交 StorJ 金额和对应操作的交易
		- 卫星审核后返回数据节点位置和操作签名
		- 客户使用这个签名和数据请求数据节点上传数据
		- 客户和被请求的节点在完成请求后，均会签名向卫星返回操作成功
		- 卫星将存储这个交易记录
		- 卫星每天对存储节点进行审查操作，证明数据存在
		- 卫星定期(默认月结)对检查正常的存储节点支付累计费用
	- 问题
		- 如果存储节点客户流失率高，则卫星将托管一部分存储节点的付款(延期支付)
			- 直到存储节点恢复正常(考察期6个月以上) 
			- 存储节点退出卫星，则延期支付款项将扣除支付给代替存储节点
		- 存储节点存储的数据已经过期，而且因为网络等原因错过了卫星通知回收的信号，这些多余存储的数据卫星将不予付费，但存储节点可以通过垃圾回收机制回收这部分资源。 
		- 卫星负责维护所有客户存储的文件以及存储节点之间的关系，每天都会对每个文件进行计费
		- 卫星还跟踪客户使用存储节点的带宽
		- 客户还需要为数据、检索、访问、审查、修复、元数据存储为卫星付款
		- 卫星还将恶意节点的收费用于支付数据修复存储等费用
- 存储(价值体系)

## 系统设计原则
- 安全和隐私为第一原则，所有和这条冲突的原则，都将遵循这个原则，加密算法支持可插拔
- 去中心化原则
	- 默认应用将链接"多个卫星提供商"
	- 成本最低原则，想办法降低维护和带宽消耗成本
- 利益模型
	- 最终用户(c端)
	
		价值为提供廉价且拥有云服务一样的性能、稳定性、安全性
	- 存储节点提供商

		提供相对合理的利润，不光是利用现有剩余容量，而需要达到创造新容量也可以有利润，这样达到网络持续扩充
	- 需求提供商-卫星节点(2b？)

		为需求提供者提供公平、透明的向合作伙伴提供利润
	- Storj 网络运营商(Storj Labs，Inc)

		从最终用户、存储节点、需求提供收取维持运行的利润 
- 应用引流，兼容 S3 ，兼容以下接口，支持 S3 开发的软件

		// Bucket operations 
		CreateBucket(bucketName) 
		DeleteBucket(bucketName) 
		ListBuckets ()ß
		
		// Object operations 
		GetObject(bucketName , objectPath , offset , length) 
		PutObject(bucketName , objectPath , data , metadata) 
		DeleteObject(bucketName , objectPath) 
		ListObjects(bucketName , prefix , startKey , limit , delimiter)
- 定义技术标准
	- 耐用性设计 99.99%
	- Qos 延迟解决方案(通过并行方案)
	- 带宽和流量控制能力
	- 存储对象数据大小规定，小文件聚合技术(类似于 git)
	- 拜占庭容错-恶意节点问题

		鼓励网络的激励措施确保网络上的理性节点的行为与无私性节点的预期行为相似。同样，拜占庭节点行为的影响必须最小化或消除
		
		- 拜占庭节点

			故意捣乱节点
		- 无私节点
		
			良好的参与者
		- 理性节点

			利益最大化者，如果拜占庭节点导致利益最大化，就偏向恶意，反之，偏向无私节点
	- 避免协作(避免一致性共识？)

		与组件协作达到正确性系统相比，协作并发执行操作会导致停顿，而避免协作的系统吞吐量在内网要提高2倍以上，而公网则提高3个数量级。传统通过增加资源来解决性能和吞吐问题，而依赖于协作的系统，比如比特币将将不是如此。为了达成 EB 级别存储能力，将路径协作域限制在每个用户范围是策略的关键组成部分之一。	

## 提供服务
- 框架设计
	- 存储数据
	
		客户端分散数据(加密、分片),上传到网络种，网络将生成存储元数据索引信息进行再次查找。
	- 检索数据
	
		客户端引用元数据进行识别分片位置，再获取分片在客户端重新组装
	- 维护数据
	
		当冗余量下降到阈值，将触发数据恢复，重生成并替换丢失数据
	- 付费使用
	
		所有操作均收费，所以需要发送价格 token 换取服务
- 组件设计
	- 存储节点

		存储、返回数据。可以通过更改协议的变量来选择节点，选择过程是一个明确且不确定的过程，这导致节点选择无法使用 DHT 这样确定节点的算法，而是通过元数据的方法，类似GFS或 HDFS。变量为
		
		- 查验时间 ping ?
		- 延迟
		- 吞吐量
		- 带宽上限
		- 足够的磁盘空间
		- 地理位置
		- 正常运行时间
		- 对审查进行准确响应的历史记录等
	- P2P 通讯和服务发现

		对等网络均通过标准协议进行通讯，框架协议包含
		
		- 通过 NAT 穿透技术
		- 通过 S/Kademlia 身份验方式证避免中间人攻击
		- 提供完整的隐私方案，保证客户端和存储节点之间通讯时不会被监听，默认通讯都是私有
		- 通过唯一标识符查找对等网络地址，类似 DNS ,但与 DNS 不同的是无法集中注册，所以需要构建 overlay 网络来解决，如 Chord、Pastry 、Kademlia
	- 冗余(高可用性)
		- 制定 SLA 规则
		- 通过 EC 和公式来解决数据高可用性(之前还支持简单冗余，但在拜占庭环境无法保证一定的数据可用性)

			EC 是一种用于处理数据持久性而不将其与带宽使用联系在一起的编码方案，并且发现它可以大大提高复制的修复效率。重要的是，它们允许在不改变膨胀系数的情况下改变耐用性
			
			- EC 对流媒体的影响
			- 避免长尾响应时间问题
				- 上传

					将文件编码设置更高可用度编码率，上传足够分片后，取消其他分片上传
				- 下载

					同样只用下载足够的分片即可，不需要全部下载冗余分片，分片分配越广阔，并发效果越好，下载效率越高
	- 元数据
		- 系统允许用户根据不同情况选择存储，所以需要选择显式节点选择方案(如元数据查询)，而不是一致性哈希方式(如 ipfs)
		- 为了兼容 S3,用户必须可以选择视为路径的任意密钥，以识别数据到节点的映射
			- S3 兼容性的要求
			- 3 的兼容性再次提出了一些严格的要求。应该支持：
				- 分层对象（带有前缀的路径)
				- 每个对象的键/值存储
				- 任意大的文件
				- 任意数量的文件
				- 任意键存储和索引
				- 允许分页查询
				- 等等
		- 解决元数据规模问题，比如 EB 数据，需要 55 TB 元数据，利用用户元数据分区原则，100 TB 的元数据产生 5.5 GB 元数据，数据越小，带来的元数据开销越大。
		- 解决元数据存储可以互换原则，希望实现整合元数据存储的多种实现方式，允许客户在其中选择，帮助客户避免用户之间协调设计。
		- 元数据存储
			- 文件元数据，如路径
			- 加密元数据 ，如加密算法、密钥信息
	- 加密
		- 功能 
			- 所有数据和元数据均需要被加密
			- 数据存储前进行加密(离开用户计算机)
			- 用户的应用和 S3 兼容客户端库同时运行
			- 加密设计成可插拔，允许客户自己定义加密方案，并可以存储加密方案的元数据，允许用户更改、升级加密方案的同时可以恢复数据，默认支持 AES-GCM 和 NaCl 的 Salsa20 和 Poly1305 组合
			- 每个文件使用不同的加密密钥，而每个文件都应该只有唯一的密钥加密。这样允许客户共享某些特定的文件而不泄露其他信息。
			- 加密应遵从 BIP 32 分层加密方案，给路径加密
		- 加密对象
			- 数据加密
			- 路径加密
			- 扩展加密  
	- 审查和声誉

		在存储系统中，审核只是一种用于确定节点的稳定性的机制(不是数据稳定性)。审核失败将导致存储节点被标记为不良，这将导致数据会重新分配给新节点，并在未来屏蔽该节点。存储节点的正常运行时间和整体运行状况是用于确定哪些文件需要维修的主要指标。审核机制并不审核所有文件中的所有字节，可能会产生误报(验证者会认为存储节点在实际修改或部分删除数据后会，依然保留完整的数据)，但对单个部分审核的误报概率很容易计算，对丢失或更改的数据的检测将确定在已知且可修改的错误阈值之内。
	- 数据修复

		审核正在验证是否合格的节点正确存储了数据，所以剩下的一切就是检测存储节点何时停止正确存储数据或恢复正常运行，然后将其必须的数据修复到新节点。为了修复数据，我们将通过 EC 重构从剩余的数据块中恢复原始数据，然后重新生成丢失的数据块，并将其存储回网络中的新存储节点上。系统中至关重要的是激励存储节点参与者保持在线状态的时间。
	- 付款

		框架着重于博弈论模型，以确保网络中的参与者被适当激励以留在网络中，并表现得合理以获取报酬。Storj 网络与支付无关，并且该协议不需要特定的支付类型，但该网络将基于以太坊的 STORJ 令牌作为默认的支付机制。				
## 框架实施
- 架构角色定义
	- 客户端

		将从网络上载或下载数据的用户或应用程序
	- P2P 对等网络

		网络上所有都通过 P2P 标准通讯进行通讯。网络中服务的三个对等类为：
		
		- 存储节点(对象存储服务器)

			对象存储服务器保存系统中存储的大量数据。
		- 卫星(元数据服务器)

			元数据服务器跟踪每个对象的元数据以及对象在对象存储服务器上的位置。
		- 上行链路(支持 libuplink 的客户端)

			客户端通过与元数据服务器和对象存储服务器进行通信，可以提供一致的视图并轻松访问文件。
	- 存储节点

		将参与节点的发现系统，为其他类节点存储数据，并为存储和带宽收费。为了简化临时文件的生命周期管理，存储节点还跟踪每个可选的“生存时间”或 TTL 名称，预期在到期日期之后删除数据，如果没有提供 TTL 将预期永久保存，这意味着节点需要具有到期时间数据库，并必须定期清除旧数据。节点还跟踪已经签名带宽分配，并发送给卫星结算，TTL和带宽分配将都存储在 SQLite 数据库中。
		
		卫星付费给存储节点的两种途径
		
		- 出口带宽形式，返回数据
		- 存储静态数据

		存储节点支持三种方法,每种方法都拥有分片ID、卫星ID，关联的卫星实例的签名以及带宽分配。
		
		- get

			put 操作检索字节的任何范围
		- put
		
			put 操作将获取字节流和可选的 TTL，并存储字节，以便可以通过 get 操作再次检索字节的任何范围
		- del
		
			直到 TTL 过期（如果提供了 TTL）或直到收到删除操作（以先到者为准），获取操作都将一直有效
		
		允许管理员配置最近 30 天内允许的最大磁盘空间和每个卫星的带宽使用情况。节点将根据这2个余额设置来适当拒绝卫星的没有有效签名的操作。
	- 上行链路(客户端)

		表示实现 libuplink 并希望存储和或检索数据的任何应用程序或服务。此类同级类预计不会像其他两个类那样保持在线状态，并且相对较轻。它将执行加密、EC、并与其他对等类进行协调。
		
		- libuplink(SDK)

			一个库，提供所有必需的功能以直接与存储节点和卫星节点交互。该库将以多种不同的编程语言提供。
		- 网关(API)

			一项服务，提供其他对象存储服务（例如S3）和 libuplink 之间的兼容性层，并公开 S3 兼容的API。
		- Uplink CLI

			命令行界面，用于上载、下载文件，管理权限和共享以及管理帐户
	- 卫星

		参与节点是发现系统，提供
		
		- 缓存节点地址信息，用于节点发现
		- 按加密路径索引的按每个对象存储的元数据数据库
		- 节点审查和节点信誉统计系统
		- 数据修复服务
		- 帐户管理和授权系统
		- 汇总账单数据
		- 支付存储节点费用

		用户使用帐户凭据登录到特定的卫星。尽管计划了各种级别的导出和导入，模型规定但同一时刻，通过一个卫星获得的数据将无法通过另一个卫星获得，关于客户数据，从不向卫星提供未加密的数据，并且不持有加密密钥。卫星支持与第三方共享的对象的唯一标示，粗略大小以及其他元数据（例如访问模式）。该系统保护客户的隐私，并赋予客户对数据访问的完全控制权，同时将保持网络上可用文件的职责委派给卫星。

- 数据类型定义
	- 桶(Bucket)
		
		定义和S3相同，桶是通过路径标识的方法创建文件命名的边界集合。每个文件在存储桶中都有唯一的路径。
	- 路径(Path)
	
		定义和S3相同，路径是存储桶中文件的唯一标识符。路径是任意字节串。路径在访问控制边界处包含正斜杠。正斜杠（称为路径分隔符）分隔路径组件。示例路径  `video/carlsagan/gloriousdawn.mp4`，其中路径是 video，carlsagan 和 gloriousdawn.mp4。
		
		除非另有要求，否则在路径离开客户应用程序的计算机之前对其进行加密。
	- 文件或对象(File or Object)
		
		定义和S3相同，文件（或对象）是系统中的主要数据类型。文件由路径引用，包含任意数量的字节，并没有最小或最大大小。文件可以用一个或多个数据分片的有序集合表示。数据分片具有固定的最大大小。文件还支持用户定义的数量有限的键/值字段(标签)，称为扩展属性。像路径一样，文件中包含的数据在离开客户端计算机之前就已加密。
	- 扩展属性(Extended attribute)
	
		扩展属性是与文件关联的用户定义的键/值字段(标签)。像其他文件元数据一样，扩展属性也以加密方式存储。
	- 数据分片(Segment)
	
		数据分片代表单个字节数组，介于0和用户可配置的最大段大小之间。一个文件可能被切割成多个有序的数据分片。有关更多详细信息，请参见第4.8.2节。
	- 远程数据分片 (Remote Segment)
	
		远程数据分片是网络上分散的 EC 数据。远程数据分片大于所需的元数据，因为包含存储了其他信息，如网络位置信息:存储数据的节点的 ID 之类的信息。
	- 内联数据分片(Inline Segment)
	
		内联数据分片是一个足够小的数据分片，它表示的数据比远程数据分片规定所需的数据大小要小。需要跟踪那些节点具有相应的数据。这种情况下数据存储在 “内联” 的卫星上，而不是存储在节点上。
	- 条带(stripe)
		
		条带是数据分片的进一步细分。 条带是固定数量的字节，用作为加密和 EC 的大小边界。 EC 分别在条带上进行，而加密一次可以在条带的一小部分上进行。 所有数据分片均已加密，但只有远程数据分片会擦除条带。 条带是执行审核的单位。 有关更多详细信息，请参见第4.8.3节。
	- EC 片段(Erasure Share )
	
		当对条带进行 EC 时，它将生成多个片段，称为 EC 片段。 只需要一部分 EC 片段即可恢复原始条带。 每个 EC 片段都有一个索引来标识它是哪个 EC 片段（例如，第一个，第二个等）。
	- 片段 (Piece)
	
		当一个远程数据分片的条带被 EC 为片段时，具有相同索引的 EC 片段被串联在一起，并将该串联的 EC 片段组被称为一块。 如果 EC 条带后有 n 个 EC 片段，则在处理远程数据分片后有 n 个片。 第 i 个片是该文件中所有的 i 索引 EC 片段的串联。 有关更多详细信息，请参见第4.8.5节。
	- 指针(pointer)
	
		指针是一种数据结构，它包含内联数据分片或者跟踪远程数据分片存储在哪个存储节点上以及其他文件的元数据。
		
		- 哪些节点正在存储碎片
		- 加密信息
		- EC 详细信息
		- 确定阈值的分片数
- 授权

	存储节点、卫星和上行链路(客户端)均会生成自己的ID(公钥地址)和证书以供在网络中使用。 ID 用于节点发现和路由。节点使用叶子密钥对进行通信。每个叶子都有一个签名的时间戳，卫星会跟踪每个节点。如果叶子受到威胁，则节点可以发出带有更高时间戳的新叶子。有兴趣的节点会记下新叶子时间戳，并拒绝来自具有较旧叶子证书的节点的连接。作为一种优化的特殊情况，当叶证书和证书颁发机构共享相同的时间戳时，对等方将无需记录。
	
	使用 macaroons 授权用户可以对卫星上的元数据进行操作，存储节点只接受卫星 ID 授权的对应 ID 下数据的操作。
- P2P 通讯

	最初在µTP [56]传输协议之上建立的传输层安全协议（TLS）[55]，在传输层安全协议之上使用的 gRPC [54] 协议，并添加了用于 NAT（STUN）功能的会话遍历实用程序[29] 。 

	- µTP具有 LEDBAT [57] 功能，可提供可靠的有序交付(如TCP);
	- TLS 提供隐私和身份验证； 
	- gRPC 提供了多路复用和便利的编程器界面;
	- LEDBAT 使互联网流量具有较高的 Qos 优先级，从而为家庭运营商提供了更优雅的用户体验，同时减少了网络使用干扰。
	- STUN 提供 NAT 遍历，NAT 穿透； 

	人工干预
	
	- 无法通过 NAT 或防火墙链接成功的，需要提供人工干预和端口转发，未来可以通过流量代理节点来实现通讯，不过需要付费。
	- 可以通过配置工作量证明来调整卫星审核节点的难度
- 节点之间的发现
	-  Kademlia 分布式哈希表（DHT）
	
		节点发现系统的目标是提供一种通过节点 ID 查找节点的方法，类似于 DNS，解决消费网络动态 IP 的问题。通过 Kademlia 分布式哈希表（DHT）是具有内置节点查找协议的键/值存储。 将 Kademlia 用作类似 DNS 的用于节点查找的功能的主要事实来源。通过在适当的地方使用 S/Kademlia [32] 扩展，来避免了许多其他已知的攻击，例如，

		- 基于所有者的密钥重新发布
		- 基于邻居的密钥重新发布
		- 值的存储和检索等等

		DHT 网络路由添加审批机制
		
		- 两个存储节点 A 和 B ，不允许未经审核存储节点 B 进入存储节点 A 的路由表
		- 直到存储节点 B 可以显示来自卫星 C 的签名消息为止
		- 存储节点 A 信任该消息， B 声称已通过了 C 信任的足够审核它（第4.13和4.15节）

		这样可以确保只有具有经过验证的磁盘空间的节点才有机会参与路由层。允许输入路由表的节点被视为经过审查，并且仅在经过审查的节点上进行查找。为了确保仍然可以找到未经审查的节点
		
		- 如果到所有未经审查的邻居的 XOR 距离不超过 k 个最近审查的邻居的最远距离，则经过审查的节点会保留其未经审查的邻居的不受限制的列表
		- 未经审查的节点保持其 k 最近审查的节点为最新
	- 缓存服务	
		
		Kademlia 之类的 DHT 需要多次网络往返来进行许多操作，这使其难以获得毫秒级的响应时间。为了解决这个问题，我们在 Kademlia 的基础上添加了基本的分散式缓存服务。
		
		- 缓存服务将独立存在于每个卫星中并尝试与网络中的每个存储节点持续进行通信，默认每小时一次
		- 然后，缓存服务将为每个节点缓存最后一个已知的正确地址，并驱逐一段时间后未与之通信的节点。
		- 无需扩展存储节点使用这些缓存服务即可。

		由于 ping 操作成本很低，我们希望此方法可以在合理的将来扩展，但是承认最终可能需要新的解决方案。幸运的是，空间需求可以忽略不计。例如，仅 5MB 内存就可以为 80k 个节点的网络缓存地址。基于这种设计，不会期望每个卫星的缓存都是真实的主要来源，并且缓存中的结果可能是陈旧的。但由于我们采用了冗余存储策略，因此存储网络将能够抵御预期的节点波动和陈旧程度。因此，即使高速缓存中的某些查找失败或返回不正确的地址，系统也将很健壮。

 		尽管从属缓存无法作为精准查询的主要来源，但是由于修复需要快速确定节点是联机还是非联机，系统中的查询将以缓存查询为主并且不会尝试使用 Kademlia 进行其他查询。仅在审核请求失败的情况下，才进行回退在 Kademlia 中进行非并行查找以更正潜在的陈旧缓存信息。
 		
 		Kademlia 消息将使用对等通信协议（第4.5节），其中包括机密性和对等身份标识。 由于这需要加密设置，因此将尽可能缓存与 Kademlia 邻居和经常联系的连接。
 		
 - 冗余

	使用 Reed-Solomon EC [59]，为了实现减少网路长尾效应的解决方案（请参阅第3.4.2节），我们为存储的每个对象选择4个数字，即k，m，o和n，`k≤m≤o≤n`

	- k

		重建所需的最小片段数
	- n
	
		在创建过程中生成的片段总数
	- m
	
		最小安全值，选择 m 值是为了使如果卫星注意到可用片段的数量已降至 m 以下，它将立即触发数据修复，以确保系统始终保持 k 或更多片段，保证数据耐用性
	- o
	
		最佳值，为了实现的长尾性能改进，选择值 o 使得在上载和修复期间，一旦 o 件完成上载，将取消剩余的 n 件。此外，选择 o 使得存储 o 件即可达到所需的耐用性目标。如果选择 n 使得存储 n 件将具有过度的耐用性。
- 审查

	存储系统中的一个假设是，大多数存储节点行为合理，并且激励措施是一致的，从而可以忠实地存储大多数数据。只要这个假设成立，Reed-Solomon 就能通过 Berlekamp-Welch 错误校正算法来检测错误甚至纠正错误。
	
	- 要执行审核，首先选择一个条带
	- 要求所有存储节点对应这段共享条带的 EC 分段
	- 然后，在所有 EC 分段运行 Berlekamp-Welch 算法[39,73]
	- 当足够多的存储节点返回正确的信息时，可以轻松地识别出任何错误或缺失的响应	
	审查失败也可能是缓存地址陈旧，因此失败后将尝试从 Kademlia 查找最新地址
	
	- 因此将尝试从 Kademlia 查找最新地址。
	- 如果该节点仍然看起来是正常的，则卫星会将节点置于遏制模式
		- 遏制模式下卫星将暂停该节点响应，然后对节点进行相同审核，直到该节点成功响应，主动使审核失败或由于响应时间过长都会被取消服务资格。
		- 如果节点成功响应后，它将退出遏制模式。
	
	所有审核失败都将被存储并保存在信誉系统中。审核还提供了测试存储节点延迟，吞吐量，响应能力和正常运行时间的机会，此数据也将保存在信誉系统中。每个节点都会被频繁的随机审查，以获取有关该存储节点运行状况的统计能力
- 数据恢复
	- 卫星将通过节点发现缓存，而不是 DHT 来确认存储节点的最近的联机情况
		- 当存储节点的状态从最近在线更改为在线时(最新刷新)，可能会触发用户元数据数据库中反向索引的查找，从而确定该节点上存储的所有 EC 片段指针  
	- 卫星一旦发现某个文件的 EC 条带数量降低到阈值以下，将会触发修复。(如果节点完好而数据异常，卫星则会标记文件在该节点丢失)
	- 卫星上重新用 EC 分片组装对应的数据块，并上传到新的存储节点
	- 卫星将更新用户的数据指针变更新的存储节点
	- 用户可以根据需求在卫星上选择数据耐用性指标(这会影响价格和一定的性能)
		- 该指标定义的耐用性将告诉选择 Reed-Solomon EC 参数指标
		- 还会定义上传 EC 分段数量值和修复阈值
	
	标准配置下卫星的审查和修复系统出流量(出站)带宽的需求较小，但进流量(入站)带宽需求很大。大量数据会进入卫星系统进行审查和维修，但只有丢失的数据会被发回网络。验证数据完整性将通过数据 HASH 完成,存储节点会将数据和对的HASH存储，而卫星将存储校验数据 HASH 值。 
	
	过多的正常运行时间检查是不合格将可以设置该存储节点以进行维护，但是如果该卫星存储节点过多出现这样的问题，则会导致会对网络正常使用造成不利影响。
- 存储节点信誉

	存储节点信誉优先算法仅用于选择将新数据存储路由(修复和上传新文件阶段)，如果存储节点的优先信誉降低，则其存储的文件将不会移动或修复到其他节点。信誉最初不会在卫星之间共享。但随着时间的流逝信誉将在全局范围内使用。不遵循规则的存储节点对系统无用，分为4个子系统
	
	- 工作证明系统

		存储节点需要生成一部分工作量证明，但和比特币不同，Storj 并不告知工作量证明难度如何设置的机制。卫星将负责设置管理存储节点的工作量证明的最低难度。如果存储节点的工作量证明难度小于卫星设置的难度，卫星节点将不会选择其为存储数据的对象。在工作量证明难度配置发生变化的时，卫星将在可能会将现有数据保留在现有节点上。
	- 初始审查过程

		当存储节点首次加入网络时其可靠性是未知的。结果，它将被置于审查过程中，直到知道足够的数据为止。
		
		- 通过设置上传新数据到网络时，分配不影响耐用性分段的少量数据到新加入节点，直到确认其稳定后，再通过审查。
		- 在存储节点存储了足够长时间(最少一个付款周期)的数据后
			- 卫星向其发送一条签名信息，声明其通过审查
			- 该存储节点信息会增加到其他节点路由表中
			- 获得审查期间的存储费用
	- 过滤系统
		- 卫星过滤 
			- 过滤异常节点
				- 没有提供充分工作证明的节点
				- 客户端尝试从该节点下载数据，而节点未能将其返还
				- 审查阶段
					- 审查失败太多
					- 未能以合理的速度返回数据
					- 没有大量运行正常时间检查
			- 过滤操作
				- 节点不在选择用于存储数据
				- 该节点存储的数据也将移动到其他存储节点
		- 存储节点过滤

			存储节点也被允许选择要使用的卫星运营商以及要存储的数据，将被允许拒绝和取消某个卫星操作。
	- 偏好系统
	
		偏好系统会统计正常数据节点的特征信息，并且会合并到上传服务的负载均衡中，客户端上载将对应选择偏好的节点，但任何节点虽然偏好不同，但机会都不为零。
		
		- 吞吐量
		- 延迟
		- 可靠性
		- 正常运行时间的历史记录
		- 地理位置
		- 及其他所需的数据
- 付款方式

	付款是由客户将数据存储到选择卫星上传时进行。客户可以通过任意方式对卫星付款，但卫星需要通过 storj 币按月对存储节点付款。卫星需要向存储节点支付它们在网络上提供的存储量和带宽费用。
	
	- 存储数据

		存储数据用户可以选择短期存储和无限期存储，将不提供合约来管理付款和文件存储，而是默认 选择数据无限期。
	- 下载费用

		卫星数据传输费用将不会实时结算给存储节点，而是按照月周期来结算(如果没有取消资格)
	- 费用托管

		如果一个存储节点的客户流失率过高，卫星将托管一部分该存储节点的付款，直到该存储节点恢复正常数据统计(半年以上)，如果存储节点离开网络，则卫星将收回向其托管款项。
	- 脏数据费用

		某个正常的存储节点错过了卫星发送的数据删除命令，则卫星无需为此类数据付费。存储节点最终将通过 GC 回收过程清理脏数据。
	- 卫星收费

		卫星会从账户持有人哪里收费，用于支付存储节点数据存储、下载，卫星节点检索、审查、修复和存储元数据的费用，(元数据按分片收费，下载按字节收收费)	
	- 卫星付费

		卫星维护着所有它管理数据对应节点的元数据数据库，它需要为每个存储节点每天增加费用来(存储数据费用和流量费用)。它会跟踪已经利用的带宽。每月月底将给存储节点支付累计费用。
		
		如果发现作恶存储节点，卫星将不为其付费，而会将费用使用在恢复数据的新节点以及修复的费用上。
- 带宽分配

	带宽计费方式使用 Neuman 基于代理的授权和对分布式系统的计费。此记帐协议以委派和分散的方式更正确地测量资源使用情况。根据 Neuman 的会计协议，如果帐户持有人有足够的资金来支付该操作，则帐户服务器将创建一个经过签名的数字支票并将其转移给该帐户持有人。协议将此检查称为代理，我们称为带宽分配。该支票包含以下信息：

	- 帐号服务器
	- 付款人
	- 收款人
	- 可用于操作的最大资源量
	- 防止任何双重支出问题的支票号码[80]以及到期日期	
	例子中

	- 帐户服务器是卫星
	- 付款人是上行链路
	- 收款人是存储节点
	- 所讨论的资源是带宽
	
	仅在请求授权上行链路的情况下卫星才会创建带宽分配。在存储操作开始时，
	
	- 上行链路可以将带宽分配传输到存储节点
	- 存储节点可以验证卫星的签名并执行请求的操作，直到达到允许的带宽限制
	- 然后将带宽分配发送给卫星以进行支付。			
	我们不让存储节点在不执行所请求的操作的情况下保存带宽分配，而是将每个操作分成较小的请求。这样，如果存储节点或上行链路早地停止过协议，则双方都不会暴露给过多的利益而失利。这类似于乐观，逐步释放，公平交换的协议。为了用 Neuman 的记帐协议和较少的卫星开销支持这一点，我们使用了受限的带宽分配。
	
	为了用 Neuman 的记帐协议和较少的卫星开销支持这一点，我们使用了受限的带宽分配（在[79]中称为受限代理）。Neuman 的受限代理的工作方式与 Macaroons[68]相似，在其中可以添加无法消除的设置而限制了代理的功能。代理可以使用任意的公钥/私钥加密，这意味着任何人都可以验证代理。因为每个上行链路已经有一个密钥对作为其身份的一部分（第4.4节），所以使用现有的密钥对，而不是为每个限制都创建一个新的密钥对。
	
	在进行 Get 操作的情况下
	
	- 假定卫星签名的带宽分配最多允许总共x个字节。
	- 上行链路将首先发送少量（y个字节）（可能只有几千字节）的受限分配给存储节点，以便存储节点可以验证上行链路的授权。
	- 如果存储节点验证分配已正确签名，则存储节点将在等待另一个分配之前最多传输受限分配中列出的数量（y个字节)。
	- 然后，上行链路将发送另一个y较大的分配，继续发送数据分配，直到y增长到完整的x值为止。
	- 对于每个事务，存储节点仅发送以前未发送的数据，因此存储节点仅发送总计x个字节。

	对这些请求进行了流水处理，以避免流水线停止性能的损失。如果带宽超出分配的范围，则存储节点将拒绝该请求。
	
	该系统不会衡量所有的点对点流量。该带宽流量测量系统仅跟踪存储操作（存储和检索件）期间使用的带宽。 但是，它不适用于节点发现流量（Kademlia DHT）或其他常规维护开销。
- 卫星信誉
	- 当新的卫星加入网络时，参与的存储节点将开始自己的审查过程。过程结束前，将限制存储节点接触未知信誉卫星
	- 存储节点将能够为不信任的卫星配置最大存储的数据量，并将建立有关将来是否会进一步信任该卫星的历史数据。
	- 存储节点运营商还将保留对其将信任或不信任哪些卫星的手动控制。
	- 官方还提供推荐列表，标准化官方推荐卫星的各种 SLA 规定和协议
- 垃圾回收
	- 主动 GC 系统
		当客户端移动、替换或删除数据时，卫星或代表卫星的客户端将通知存储节点不再需要它们来存储该数据。
		
		- 在客户端发出删除消息的配置中
		- 卫星元数据系统将需要将删除证明发布到可配置的最小数量的存储节点。
		- 这意味着每次删除数据时，在线且可访问的存储节点都将立即收到通知。
	- 被动 GC 系统

		被动 GC 系统将使用保守垃圾回收策略，当卫星节点"亏空"存储费用以摊销存储垃圾的成本时启动。
		
		- 存储节点将定期(每个结算周期)请求一个数据结构来检测差异。以最简单的形式，它可以是存储密钥的散列，从而可以有效地检测不同步状态。
		- 在检测到不同步状态后，收集可以使用其他结构（例如 Bloom 过滤器[82]）来找出尚未删除的数据。
		- 通过定期返回针对每个节点量身定制的数据结构，卫星可以使存储节点能够以可配置的容忍度清理垃圾数据。
		- 卫星将拒绝对这些数据结构的过于频繁的请求。

## 操作整理流程
- 客户端
	- 上传
		- 向卫星请求发送对象，包含凭证、身份证书
		- 卫星接到请求后处理
			- 确认上行链路具有适当授权和资金
			- 选择足够资源额节点，符合用户偏好设置
		- 卫星返回客户端相关数据(节点列表、带宽分配、所选根部 ID(桶ID))
		- 客户端接受卫星信息，并处理
			- 按照客户设置对上传数据进行处理(包含切片、加密、EC(设置耐用性)、组合片段等)
			- 片段并行传输到每个存储节点
			- 数据将继续传输，直到达到最大片段阈值或流结束
			- 每段的所有 HASH 将被写入每段流的末尾
		- 存储节点
			- 分配最大的受限带宽
			- 设置片段的 TTL
			- 数据将通过存储节点特定的片段 ID和委派的卫星 ID 进行标识
		- 上传结果
			- 失败

				如果由于某种原因中止了上传，则存储节点将保留它代表卫星从客户端上行链路接收到的最大受限带宽分配，但会丢弃所有其他相关请求数据。
			- 成功
				- 上行链路使用确定性的分层密钥来加密文件选择的随机加密密钥
				- 上行链路会将指针对象上传回卫星，其中包含以下信息
					- 哪些存储节点最终成功
					- 为片段选择了哪种加密路径
					- 使用 EC 算法的参数
					- 片段 ID
					- 加密的数据随机密钥和其他元数据
					- HASH
					- 一个签名
		- 最后，上行链路将继续进行下一个片段，继续处理片段，直到整个流都已完成。每个片段都有一个新的加密密钥，但是该片段的开始随机数比前一个片段单调增加。

			流中存储的最后一个片段将包含其他元数据(指针)
			
			- 流包含多少片段
			- 片段的大小（以字节为单位）
			- 第一段的开始随机数
			- 扩展属性和其他元数据
		- 存储节点将作为上载的一部分，将收到的最大受限带宽分配发送到对应的卫星进行消费凭证      
	- 下载
		- 上行链路
			- 首先用户向上行链路发送数据请求
			- 然后，上行链路通过推测性地向卫星请求除最后一个片段的指针外的前几个片段的指针，来尝试减少到​​卫星的往返次数
			- 上行链路需要最后一个片段指针来了解对象的大小、片段的大小和数量以及如何解密数据
		- 卫星对于请求的每个分段指针
			- 确认上行链路有权下载片段指针，并且有足够的资金来支付下载费用
			- 为组成该片段的每个片段生成不受限制的带宽分配
			- 查找指针中列出的存储节点的联系信息
			- 返回每个片段的请求的段指针，带宽分配和节点联系信息
		- 上行链路将确定对于接收到的数据请求是否需要更多的片段，并在需要时请求其余的片段指针。
			- 一旦返回了所有必需的片段指针，如果请求的片段不是内联的，则上行链路将启动并行请求，同时测量每个存储片段内适当 EC 范围内所有适当存储节点的带宽(由于并非所有 EC 片段都是恢复所必需的。因此，通过允许上行链路取消最慢的下载，可以消除长尾巴，并显着提高性能。)
			- 上行链路会将检索到的 EC 片段合并为加密条带并解密数据获取数据分片
		- 结果	
			- 成功	
				- 最终获取所有数据分片，组合所有分片还原数据
			- 失败
				- 如果由于某种原因中止下载，则每个存储节点将保留其收到的最大受限带宽分配，但会丢弃所有其他相关请求数据。无论哪种方式，存储节点都将在以后将它们作为下载的一部分收到的最大受限带宽分配发送到卫星，以供以后付款。
	- 删除
		- 上行链路
			- 当用户想要删除文件时，删除操作首先由上行链路接收。
			- 然后，上行链路请求文件的所有片段指针。
		- 卫星对于每个片段指针
			- 验证上行链路有权删除片段指针
			- 生成删除片段的已签署协议(因此存储节点知道卫星期望删除继续进行)
			- 查找指针中列出的存储节点的联系信息
			- 返回上行链路细分，协议和联系信息			- 上行链路
			- 对于所有远程片段，上行链路将向所有适当的存储节点发起并行请求，以信号指示已删除这些文件。
		- 存储节点
			- 将返回签名消息，表明存储节点已接收到删除操作，并且将删除文件及其簿记信息或已将其删除
		- 上行链路
			- 会将从工作存储节点收到的所有签名消息上载回卫星。
		- 卫星
			- 将需要占总存储节点的百分比可调才能成功签署消息，以确保上行链路在通知存储节点该对象已删除时发挥了作用
			- 卫星将删除片段指针，并停止向客户收费并停止为支付对应存储节点费用
		- 上行链路
			- 将返回成功状态
		
		存储节点将定期向卫星询问生成的垃圾收集消息，这些消息将更新在主要删除事件期间处于正常状态的存储节点。卫星将拒绝过于频繁发生的垃圾收集消息请求。有关更多详细信息，请参见第4.19节。
	- 移动
		- 上行链路
		
			当用户要移动文件时，上行链路会收到将文件移动到新路径的请求。 然后，上行链路请求该文件的所有片段指针
		- 卫星对于每个分段指针
			- 验证上行链路有权下载它
			- 返回请求的细分元数据
		- 上行链路对于每个片段指针
			- 使用从路径派生的加密密钥解密元数据
			- 计算新目的地的路径
			- 使用从新路径派生的新加密密钥重新加密元数据
			- 上行链路要求卫星在原子比较和交换操作中添加所有修改后的段指针，并删除所有旧的段指针。
		- 卫星将验证
			- 上行链路具有适当的授权，可以删除旧路径并创建新路径
			- 自从整体操作开始以来，旧路径的内容没有改变
			- 如果验证成功
				-  卫星将执行该操作。 

		任何存储节点都不会收到与文件移动相关的任何请求。由于原子指针批处理修改的复杂性，在此网络的第一个版本中可能无法实现有效的移动操作。
	- 复制
		- 上行链路
			- 当用户要复制文件时，上行链路会收到将文件复制到新路径的请求。
			- 然后，上行链路请求文件的所有片段指针。
		- 卫星对于每个分段指针
			- 验证上行链路有权下载它
			- 查找指针中列出的存储节点的联系信息
			- 返回请求的片段元数据，新的根ID和联系信息
		- 上行链路对于每个段指针
			- 使用从路径派生的加密密钥解密元数据
			- 将路径更改为新目的地
			- 从指针在每个存储节点上调用复制操作，以使用新的片段 ID 复制该片段
			- 等待存储节点响应它们已复制了数据，并删除了不成功的节点
			- 使用新的片段 ID 和从新路径派生的新加密密钥重新加密元数据
			- 最后，上行链路将所有修改后的片段指针上传到卫星
		- 存储节点

			对存储进行重复数据删除或仅存储数据的一个实际副本，则可以。重要的是，存储节点可以通过新旧分段 ID 识别数据。如果其中一个分段 ID 收到删除操作，则另一个分段 ID 将继续工作。只有删除了这两个部分，节点才会释放空间。
	- 列表
		- 上行链路
			- 当用户想要列出文件时，首先，上行链路接收到列出对象页面的请求
			- 然后，上行链路会将未加密路径上的请求转换为加密路径
			- 接下来，上行链路将向卫星请求适当的加密路径页面
		- 卫星
			- 卫星将验证上行链路具有适当的访问权限，然后返回请求的列表页面
		- 上行链路
			- 将解密结果并将其返回
- 卫星
	- 审查
		- 生产审查队列
		
			每个卫星都有一个分段条带队列，将在一组存储节点之间进行审查。队列通过两种机制填充。
		
			- 第一种
			
				卫星通过随机选择片段来定期填充队列，然后在这些片段内也随机分布条纹。由于片段具有最大大小，因此这完全接近于选择随机进行统一审查的字节的目标
			- 第二种机制
			
				卫星通过标识最近审查少于其他存储节点的存储节点来选择要审查的条带。将从存储节点包含的数据中随机选择一个条带
		- 卫星将随后消费队列并报告错误
			- 对于每个条带请求，卫星将在该小条带范围内执行整个下载操作，筛选出处于包含模式的节点。与标准下载不同，条带请求不需要高效。卫星将尝试下载该条带的所有EC分片，并等待所有存储节点返回。
			- 在慷慨的超时时间内，接收到尽可能多的份额后，将对 EC 分片进行分析，以发现错误（如果有）。
			- 卫星服务器会记录返回无效数据的存储节点，如果存储节点返回过多的无效数据，卫星将取消存储节点的资格，无法进行以后的交换。在取消资格的情况下，卫星不会支付以后的存储节点，也不会选择用于新数据的存储节点。
			- 对于没有响应的存储节点，将创建并存储预期审查结果的加密校验和，并将无响应的节点置于密闭状态。在收容期间，将继续仅对节点无响应的审查进行审查，直到该节点通过或被取消资格
	- 数据恢复

		维修过程分为两个部分。第一部分检测不健康的文件，第二部分修复它们。检测很简单。
	
		- 第一部分审查
			- 通过标准节点发现 ping 操作，每个卫星将定期对其已知的每个存储节点执行 ping 操作
			- 卫星将跟踪无法响应的节点并将其标记为已关闭
			- 当节点通过审查过程被标记为向下或标记为不良时，指向该存储节点的指针将被视为需要维修。指针跟踪其最小的允许冗余。如果指针没有存储在足够好的在线存储节点上，它将被添加到修复队列中。
		- 第二部分修复
			- 卫星的辅助进程将采用修复队列中的分片段指针。在修复队列中使用段指针时：
				- 卫星将下载足够的片段以重建整个分片，以及与这些片段一起存储的片段 HASH（请参阅第4.14.1节）
					- 与审查不同，仅需要足够的分片即可进行准确的维修
					- 与流下载不同，修复系统可以在启动之前等待整个片段
				- 根据指针中的签名验证 hash
				- 然后根据经过验证的 hash 对下载的数据进行验证。不正确的部分将被丢弃，并作为存储节点失败的审查计入来源
				- 一旦恢复了足够的正确片段，就会重新生成丢失的片段
				- 卫星将选择一些新节点，然后通过正常的上载过程将新片段上载到这些新节点
				- 卫星更新指针的元数据
		
		整个修复过程不需要上行链路参与
	- 支付
		- 卫星 
			- 首先，卫星将选择累计期限。 这是一段时间（默认为一天），用于计算静态数据的费用。 这纯粹是为会计选择的时间段； 实际付款的频率会降低。
			- 在每个汇总期间，卫星将考虑其当前认为存储在每个存储节点上的所有文件。
			- 卫星将根据每个存储节点上保存的数据，跟踪每个汇总周期内为每个存储节点欠费付款。
		- 存储节点
			- 将定期（默认为每月）在带宽分配报告中发送给卫星。
		- 卫星
			- 接收到带宽分配报告后，它将计算欠款以及剩余的未处理数据。 
			- 然后，它将资金发送到存储节点的请求钱包地址
			
## 利益来源	 
- 给出的用途
	- 高可用归档(可以)
	- CDN(当前系统文档中不支持)
	- S3(可以)
	- 流媒体
		- 待验证 

## 未来目标	
- CDN
- 卫星数据终端用户备份迁移
- 数据节点共享编码文件	

## 问题	
- 应用链接多个卫星提供商，应用如何维护链接多卫星之间的数据的？
- 避免长尾
	- 上传 
		- 生成更高编码率文件效率
		- 并发上传给服务器带来压力问题
- 删除消息系统对全节点广播？

## 研究
- Lustre
- Reed-Solomon EC
- BIP32
- Berlekamp-Welch
	- HAIL 系统 
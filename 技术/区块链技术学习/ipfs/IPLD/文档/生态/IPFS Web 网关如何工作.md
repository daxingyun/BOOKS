# IPFS Web 网关如何工作
本文档讨论了 IPFS Web 网关的工作原理；用于完成部分任务的各种抽象形式；以及这些设计如何以及为什么很酷（以及如何重复使用其中的一部分）。

	笔记！这是一份雄心勃勃的文件——IPFS Web 网关是一项具有悠久历史的功能。他们并不总是这样工作。
## 目标是什么？
### 什么是 IPFS Web 网关？
“Web 网关”是 IPFS 的一项功能，它通过 HTTP 提供文件内容。它通过从请求的 URL 中获取路径并将其分成两部分来选择要提供的内容：CID和路径的其余部分。

- CID 用于选择一些数据作为起点。
- 路径的其余部分将用作遍历 IPLD 数据的指令，从 CID 识别的数据开始。
- 在该遍历结束时，我们将尝试将指向的任何内容理解为一堆字节（“文件”仅此而已）......并将其倒入 HTTP 响应中。

这很有用，因为这意味着我们可以将数据存储在 IPFS 中，并且可以像普通网页一样轻松访问该数据。
## 我们该怎么做呢？
这实际上有很多活动部件。让我们分解一下：

- 文件只是字节

	“文件”实际上只是“大字节序列”。

	... 在大多数情况下。让我们暂时接受这种简化。（稍后我们将添加有关权限和元数据的概念。）
- 大字节由 ADL（特别是 FBL）提供

	我们可以使用 [“Flexible Byte Layout (FBL)”](https://ipld.io/specs/advanced-data-layouts/fbl/) ADL来描述文件体。此 ADL 提供了一种读取分片大字节序列的通用方法。它甚至支持高效搜索！
- 目录只是 map

	“目录” 实际上只是 “map”：“目录”将文件名映射到另一个目录或文件；就是这样。

	... 在大多数情况下。让我们暂时接受这种简化。（稍后我们将添加有关权限和元数据的概念。）
- 目录由 ADL（特别是 HAMT）提供

	我们可以使用 [HAMT ADL](https://ipld.io/specs/advanced-data-layouts/hamt/) 来描述目录。此 ADL 为我们提供了分片映射，这意味着我们可以存储任意大小的目录。
- 导航路径由数据模型定义

	... 这很好，因为这意味着我们不需要任何特殊的自定义逻辑来描述我们将如何遍历这些数据。因为路径遍历都是通过 ADL，正如我们在前面的部分中描述的那样，这就是……所有的一切。

	因为拥有 ADL 定义意味着我们有办法使 ADL 的  IPLD  底层数据像常规数据模型语义一样清晰，我们可以使用标准库函数来访问此数据。根本没有为 Web 网关（或 unixfsv2 的其他用户）编写特殊的路径处理逻辑！

- IPLD Schemas 定义了在哪里使用 ADL 以及使用哪些 ADL

	... 更具体地说，Unixfsv2 模式，它非常普遍，并且比 IPFS Web 网关系统使用得更多。

	Web 网关知道 unixfsv2 的模式，并且他们假设它适用于通过网关系统请求的任何数据。

	如果数据不匹配，它将无法通过 Web 网关呈现（并且我们返回有关数据如何以及在何处停止与 unixfsv2 数据预期的模式匹配的错误）。

	如果数据确实匹配：那么模式还会告诉我们期望 ADL 在哪里生效，并且还会告诉我们一旦应用 ADL 逻辑就可以从数据中获得什么样的数据模型语义。
- 系统的不同部分可以使用不同的视图
	- 目录实际上是一个指向元数据和更多文件节点的 map。
	- 有时您使用普通的 HAMT ADL 并看到所有这些；
	- 有时，您使用的 ADL 会越过 HAMT 并直接到达文件节点。
	- 前者是写入新数据所必需的。
	- 后者提供了最终用户在像文件系统一样导航和阅读时想要的那种路径！
- 如果您没有此数据：我们获取它

	这部分直接触及 IPLD 范围内的限制，但简而言之，IPFS 中发生的是：

	- 将向 DHT（由 libp2p 提供）请求有关可能有缺失内容的任何人的信息
	- 将与其他 IPFS 节点联系（再次由 libp2p 代理，它可能正在处理 NAT 遍历等）
	- 像 bitswap 或 graphsync 这样的协议将用于从其他 IPFS 节点传送 IPLD 数据的原始块
	- ... 然后数据是本地的：进程通常从那里再次拾取。
- 如果我们想在幕后偷看怎么办？

	上面所有的结构都是用 CBOR 序列化的。所有的魔力都来自 IPLD 语义特征，如 ADL 和模式。

	这样做的妙处在于，放下所有魔法并直接查看原始数据也非常容易。

	想查看构成所有这些结构的原始 CBOR 对象吗？没问题。它们几乎隐藏在引擎盖下，我们试图让人们很容易抬起引擎盖看一眼。

	事实上，您只需使用 IPLD 库从相同的 CID 开始，然后使用常规数据模型遍历机制四处走动，就可以检查构成这些结构的所有原始 CBOR 对象。如果您提供 Unixfsv2 模式（以及它关于在何处应用 ADL 的提示），您将获得“目录”（map）和“文件”（字节）的高级视图；如果不这样做，您将转而在原始 CBOR 对象周围闲逛。
- 什么是可重复使用的？

	天哪。靠近一切。
	
	- Unixfsv2 模式是可重用的。如果你想描述类似文件系统的数据，它可能有你想要的。
	- 灵活字节布局 (FBL) 高级数据布局可重复使用，以满足您的任何大分片字节序列需求！它不是 Unixfsv2 或 IPFS Web 网关独有的；您可以将它放在任何 IPLD 系统中您想要的任何位置。
	- HAMT ADL 同样可重复使用，以满足您的任何大分片 map 需求！它不是 Unixfsv2 或 IPFS Web 网关独有的；您可以将它放在任何 IPLD 系统中您想要的任何位置。
	- ... 即使您不特别想要这些东西，希望这是一个很好的例子，说明您如何使用 IPLD 系统的各个部分来实现您自己的目标！

	整个 IPFS Web 网关系统是根据标准 IPLD 组件构建的，经过组装：模式、ADL 以及简单的基本路径和数据模型遍历是我们完成所有这些所需的全部。
- 这还有什么其他限制？

	重要的是要注意 Web 网关使用 IPLD 库完成几乎所有这些工作，而不是其他很多……但是，ADL 也有一些特殊的警告。

	因为 ADL 需要一些逻辑来使它们的数据翻译工作，并且因为 IPLD 本身不包含解释器或脚本语言运行时（即使它包含，我们也会担心限制其资源预算）...... IPLD 库通常需要明确定义允许的 ADL 列表。

	IPFS Web 网关特别允许 FBL 和 HAMT ADL。

	如果您想生成使用其他分片算法的数据，但在结构上与 Unixfsv2 模式匹配，并且希望这些数据能够被某些 IPFS Web 网关正确显示？您需要重新配置该网关以扩展允许的 ADL 列表，以包括您想要使用的任何分片系统。
- 从历史上看：这以前是如何工作的？

		这部分是历史笔记——这里是为熟悉旧系统的读者准备的，并希望了解它与上面记录的新设计的比较情况或者是为想要了解一些学习经验的读者准备的从这项工作的前几场比赛中收集的。但是，除非这两个好奇心来源之一吸引您，否则您真的不需要阅读它。
	IPFS 的最早实现使用称为“dag-pb”的编解码器来表示文件和目录。（“dag-pb”仍然作为 IPLD 编解码器存在——但如今，我们认为它是一种更有限的编解码器，而且是一个非常深奥的编解码器。）

	“dag-pb” 编解码器包含许多我们现在单独处理的职责：它在编解码器本身中包含目录（和分片）的概念（而我们现在将其拆分为`map ADL`）；类似地，它在编解码器本身中包含文件的概念（并将其组成字节分片）（而我们现在将其拆分为`字节 ADL`）。

	通过将这些东西烘焙到编解码器本身，与目前的 IPLD 系统设计相比，存在几个主要缺点：

	- 通过将这些分片机制烘焙到单个编解码器中，不可能将它们与其他编解码器一起重用；
	- 因为分片机制是在编解码器中烘焙的（当时，根本没有任何数据模型的连贯定义），所以无法在数据的高级视图和原始视图之间切换——作为结果，这些系统更难调试；
	- 由于分片机制与编解码器紧密绑定，因此无法引入甚至试验其他分片机制！

	从另一个方向看，“dag-pb” 即使具有所有特殊功能，也比现代 IPLD 系统设计更受限制：

	- 通过提取 ADL 的概念，我们也使分片其他数据结构成为可能——例如，我们现在可以轻松地支持分片列表，这是 dag-pb 中根本不存在的概念。
	- dag-pb 对数据的拓扑结构有非常（非常）严格的想法。用现代术语来说，我们会说它不支持完整的 IPLD 数据模型。dag-pb 和其他早期 IPLD 编解码器之间巨大的行为差距和可表示性的不对称性产生了很大的混乱。
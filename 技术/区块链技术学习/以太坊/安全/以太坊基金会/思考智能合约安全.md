# 思考智能合约安全
过去一天，在社区的帮助下，我们众包了迄今为止以太坊智能合约的所有主要漏洞列表，包括 DAO 以及各种较小的 100-10000 ETH 盗窃以及游戏和代币合约中的损失。

此列表（此处为原始来源）如下：

- DAO（显然）
- [“不带下划线的派息指数”庞氏 骗局](https://www.reddit.com/r/ethereum/comments/4e5y30/live_example_of_underhanded_solidity_coding_on/)（“FirePonzi”）
- [拥有公共 RNG 种子的赌场](http://martin.swende.se/blog/Breaking_the_house.html)
- [政府](https://www.reddit.com/r/ethereum/comments/4ghzhv/governmentals_1100_eth_jackpot_payout_is_stuck/)（1100 ETH 卡住，因为支出超过 gas 限制）
- [5800 ETH 从 ETH 支持的 ERC20 代币中刷出](https://www.reddit.com/r/MakerDAO/comments/4niu10/critical_ether_token_wrapper_vulnerability_eth/)（由白帽）
- [以太之王游戏](http://www.kingoftheether.com/postmortem.html)
- Rubix : 费用被盗，因为[构造函数](https://etherscan.io/address/0xe82719202e5965Cf5D9B6673B7503a3b92DE20be#code)名称不正确，允许[任何人成为所有者](https://bitcointalk.org/index.php?topic=1400536.60)
- [石头剪刀布](https://www.reddit.com/r/ethtrader/comments/4fpn6o/play_rockpaperscissors_for_1_eth_via_mist_wallet/)可被轻易作弊，因为第一个移动的人展示了他们的手
- 由于接收者包含消耗超过 2300 气体的后备功能，导致向他们发送失败，导致各种资金丢失。
- 调用堆栈限制异常的各种实例。

我们可以按错误类别对列表进行分类：

- 变量/函数命名混淆：FirePonzi、Rubixi
- 不该公开的公开数据：公开的RNG种子赌场、可作弊的RPS
- 重入（A 调用 B 调用 A）：DAO，Maker 的 ETH 支持的代币
- 由于 2300 气体限制，发送失败：以太之王
- 阵列/回路和气体限制：政府
- 更微妙的博弈论弱点，在极限情况下人们甚至争论他们是否是错误：DAO

针对智能合约安全提出了许多解决方案，从更好的开发环境到更好的编程语言再到形式验证和符号执行，研究人员已经开始开发[此类工具](http://hackingdistributed.com/2016/06/16/scanning-live-ethereum-contracts-for-bugs/)。我个人对这个话题的看法是，一个重要的主要结论如下：

	智能合约安全的进步必然是分层的、渐进的，并且必然依赖于纵深防御。
会有更多的错误，我们将学习更多的教训；不会有一种魔法技术可以解决所有问题。

这个基本结论的原因如下。智能合约被盗或丢失的所有实例——事实上，智能合约被盗或丢失的定义从根本上讲是关于实施和意图之间的差异。如果在特定情况下，实施和意图是同一件事，那么任何“盗窃”实例实际上都是捐赠，任何“损失”实例都是自愿烧钱，在经济上相当于按比例捐赠 ETH通货紧缩的代币持有者社区。这导致了下一个挑战：意图从根本上说是复杂的。

这一事实背后的哲学最好由友好的 AI 研究社区正式化，其中带有“[价值的复杂性](https://wiki.lesswrong.com/wiki/Complexity_of_value)”和“[价值的脆弱性](http://lesswrong.com/lw/y3/value_is_fragile/)”的名称”。论点很简单：

作为人类，我们有很多价值观，也有非常复杂的价值观,复杂到我们自己无法充分表达它们，任何尝试都不可避免地包含一些未被发现的极端情况。这个概念对人工智能研究的实用性很重要，因为超级智能人工智能实际上会搜索每一个角落，包括我们发现如此不直观以至于我们甚至没有想到的角落，以最大化其目标。告诉一个超级智能 AI 治愈癌症，它会通过分子生物学中的一些中等复杂的调整来达到 99.99%，但它很快就会意识到，通过核战争引发人类灭绝，它可以将这一目标提高到 100%。 或病毒大流行。告诉它在不杀死人类的情况下治愈癌症，它只会迫使所有人冻结自己，推理它在技术上不是杀戮，因为它可以唤醒人类，如果它愿意 

它就是不会。等等。

在智能合约土地上，情况类似。我们相信我们重视“公平”之类的东西，但很难定义公平到底意味着什么。你可能想说“不可能有人从 DAO 窃取 10000 ETH”，但如果对于给定的提款交易，DAO 实际批准了转账，因为收款人提供了有价值的服务？但是，如果转移被批准，我们怎么知道决定转移的机制没有被博弈论漏洞愚弄？什么是博弈论漏洞？“分裂”呢？如果是基于区块链的市场，那么抢先交易呢？如果给定的合约指定了一个可以收取费用的“所有者”，如果任何人成为所有者的能力实际上是规则的一部分，以增加乐趣呢？

所有这一切都不是针对形式验证、类型论、怪异编程语言等方面的专家；聪明的人已经知道并欣赏这些问题。但是，它确实表明，可以完成的事情存在根本障碍，并且“公平”不是可以在定理中用数学证明的东西——在某些情况下，公平声明的集合是如此冗长和复杂，以至于你有想知道这组声明本身是否可能有错误。

## 走向缓解路径
也就是说，有很多领域可以大大减少意图和实施之间的分歧。

- 一类是尝试采用通用模式并对它们进行硬编码：例如， 可以通过创建 `owner` 一个只能`msg.sender` 在构造函数中初始化为 equal 并可能在 `transferOwnership` 函数中传递的关键字来避免 Rubix 错误。
- 另一类是尝试创建尽可能多的标准化中级组件；例如，我们可能希望阻止每个赌场创建自己的随机数生成器，而是将人们引导至 RANDAO（或类似我的 RANDAO++ 提案，一旦实施）。

然而，更重要的解决方案类别涉及减轻 EVM 执行环境的特定和不直观的怪癖。其中包括：

- gas 限制（负责政府损失，以及收件人在接受发送时消耗过多 gas 造成的损失）
- 重入（负责 DAO 和 Maker ETH 合约）和调用堆栈限制。例如，调用堆栈限制可以通过这个 EIP 来减轻，它通过改变气体力学来代替它的目的，基本上将它从考虑中移除。可以完全禁止重入（即一次只允许每个合约执行一个实例），但这可能会引入新形式的不直观，因此可能需要更好的解决方案。

然而，gas 限制并没有消失。因此，唯一的解决方案可能在开发环境本身内部。如果在没有数据的情况下调用合约不能证明消耗少于 2300 gas，编译器应该发出警告；如果一个函数不能被证明在安全量的 gas 内终止，他们也应该发出警告。变量名称可能是彩色的（例如，基于名称哈希的前三个字节的 RGB），或者如果两个变量名称彼此太接近，可能会给出启发式警告。

此外，有些编码模式比其他编码模式更危险，虽然它们不应该被禁止，但应该清楚地突出显示，要求开发人员证明他们使用它们的合理性。一个特别涉及的例子如下。有两种调用操作显然是安全的。

- 第一个是包含 2300 gas 的发送（前提是我们接受这样的规范，即在空数据的情况下，接收者有责任不消耗超过 2300 gas）。
- 第二个是调用你信任的合约并且它本身已经确定是安全的（注意这个定义禁止重入，因为你必须在证明 A 是安全的之前证明 A 是安全的）。

事实证明，这个定义可以涵盖很多合同。但是，并非所有人都可以；

一个例外是“通用去中心化交易”合约的想法，任何人都可以下订单，以给定数量的资产 A 换成给定数量的资产 B，其中 A 和 B 是任意的 ERC20 兼容代币。一个人可以为少数资产制定一个特殊目的的合约，从而属于“受信任的被调用者”豁免，但拥有一个通用的合约似乎是一个非常有价值的想法。但在这种情况下，交易所需要致电 `transfer` 并 `transferFrom` 未知合约，是的，给他们足够的燃料来运行，并可能进行重入调用以试图利用交易所。在这种情况下，编译器可能想要发出明确的警告，除非使用“互斥锁”来防止在这些调用期间再次访问合约。

第三类解决方案是纵深防御。

一个例子，防止损失（但不是盗窃）是鼓励所有非永久性合同有一个到期日，在此之后所有者可以代表合约采取任意行动；这样，只有在 (i) 合约搞砸，同时 (ii) 所有者失踪或不诚实时，才有可能出现损失。受信任的多重签名“所有者”可能会出现以缓解 (ii)。可以通过增加等待期来减轻盗窃。正是因为子 DAO 被锁定了 28 天，DAO 问题在范围上得到了极大的缓解。MakerDAO 中的一个提议功能是在任何治理变更生效之前创建延迟，允许对变更时间不满意的代币持有者出售他们的代币；这也是一个好办法。

形式验证可以放在上面。一个简单的用例是作为一种证明终止的方式，大大减轻了与 gas 相关的问题。另一个用例是证明特定的属性.例如，

- “如果所有参与者串通，他们可以在任何情况下取出他们的钱”
- 或者“如果你将你的代币 A 发送到这个合约，你就可以保证获得代币的数量B 您想要或能够全额退款。” 
- 或者 “这个合约适合 Solidity 的一个受限子集，这使得重入、gas 问题和调用堆栈问题变得不可能”。

最后一点是，虽然到目前为止所有的问题都是关于意外错误，但恶意错误是一个额外的问题。我们对 MakerDAO 去中心化交易所没有让他们拿出所有资金的漏洞有多大信心？我们社区中的一些人可能知道 MakerDAO 团队并认为他们是好人，但智能合约安全模型的全部目的是提供足够强大的保证，即使不是这样也能生存，以便实体那些没有很好的联系和建立到足以让人们自动信任他们并且没有资源通过数百万美元的许可程序来建立他们的可信度的公司可以自由创新，并且让消费者使用他们的服务时对他们的安全充满信心。因此，

社区可以采取的具体行动步骤是：

- 承担制作卓越开发环境的项目，以及卓越的块/源代码浏览器，其中包括其中一些功能
- 尽可能多的组件标准化
- 承担试验不同智能合约编程语言以及形式验证和符号执行工具的项目
- 讨论可以降低意外或故意错误风险的编码标准、EIP、对 Solidity 的更改等
- 如果您正在开发价值数百万美元的智能合约应用程序，请考虑联系安全研究人员并与他们合作，将您的项目用作各种验证工具的测试用例

请注意，如前一篇博文中所述，DEVGrants 和其他赠款可用于上述大部分内容。
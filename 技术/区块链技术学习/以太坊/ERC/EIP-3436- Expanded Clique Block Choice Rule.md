# EIP-3436: Expanded Clique Block Choice Rule
## 简单总结
向 Clique 添加一个四步块规则，以减少块生产死锁
## 抽象的
Clique 的当前规范允许来自生产者的多个竞争块，但除了当前的 “最高总难度” 规则之外，没有提供任何选择块的策略。本 EIP 提出了

- 最高总难度
- 最短链
- 最近轮流
- 最低哈希

四步选择规则。这将防止在生产系统中发生死锁。

## 动机
Goerli 多客户端 Clique 网络中出现了不止一次死锁。停止由一个不活动的验证器重新上线解决。

活跃验证者的数量大于可用验证者的 1/2，因此不应该发生链停止。

链的状态是可能导致链停止的 8 个验证器的两种配置之一。 四个客户中的三个观察到总难度最低的选择序列，然后是第一个观察到的块。Geth 添加了一个额外的规则即在首选第一个观察到的块之前首选最短链。这个分叉可以通过 Geth 的规则自行解决，但仍然存在一种配置，即链可以使用最短链规则停止。
## 规格
当 Clique 验证者在两个不同的链头块之间仲裁规范状态时，他们应该选择具有以下排序优先级的规范块。

- 选择总难度最高的块
- 然后选择块号最小的块
- 然后选择验证者最近轮流区块分配的区块
- 然后选择具有最低哈希值的块

在解析规则 3 时，客户端应使用以下公式

-  `validator_index` 是根据 epoch 检查点排序时签署区块的验证器的整数索引
- `header_number` 是标头 
- `validator_count` 的数量

是当前验证器的计数。客户应该选择价值最大的区块。请注意，轮流块被认为是最近的轮流块。

	(header_number - validator_index) % validator_count
解析规则 4 时，应将散列转换为无符号 256 位整数。

## 基本原理
根据当前的总难度，然后首先观察到的规则，已知两种停止链的情况。其中一种情况也可以抵抗最短链规则。

- 情况1

	对于不同长度的链可以停止的第一种情况，考虑一个具有 8 个验证器的块，其地址排序与本示例中的指定顺序相同。存在一个完全有序的链并且 8 号验证者刚刚生成了一个轮流块，然后 5、7 和 8 号验证者下线，留下 1 到 6 号验证者来
	
	- 生成块形成两个分叉
		- 一个来自验证器 1 的有序块，
		- 另一个来自验证器 3 的无序块
			- 第二个分叉由验证器 2、4 和 6 按顺序形成。

	两者的净总难度都比共同祖先多3。因此，在这种情况下，如果两个分叉都意识到另一个分叉，那么两者都被认为是同样可行的，并且任何一组验证者都不应该切换到新观察到的分叉。
- 情况2

	对于具有相同验证器集和有序链的第二种情况，验证器 7 刚刚生成了一个有序块，然后验证器 7 和 8 下线。
	
	- 生成两个叉子
		- 一侧为 1,3,5
		- 另一侧为 2,4,6
	
	在产生第三个区块后，两个分叉都会意识到另一个分叉。在这种情况下，两个叉子的总难度和长度相等。因此，Geth 的规则不会打破平局，只有缺失的验证者之一的到来才能修复链。在最坏的情况下，奇数和偶数链将分别为 7 和 8 生成一个块，并且链停止将导致没有没有选择分叉的验证者。只有手动回滚才能解决此问题。

制定规则时的一个考虑因素是应该选择块选择，以便鼓励最大数量的有序块。基于最短链选择链隐含地偏爱具有更多有序块的链。当在竞争的无序链之间进行选择时，未来最接近生产有序区块的验证者应该拒绝其链，以便他们可以更快地产生有序区块。

观察到至少有一个客户端以相同的难度在相同的高度生成多个块，因此最低块哈希的最终全能标准应该会打破任何剩余的关系。

## 向后兼容性
当前的区块选择规则是最高总难度和最高总难度加上最短链的混合。

只要大多数活跃的验证者实施区块选择规则，那么仅实施现有基于难度的规则的客户端最终将与这些规则首选的链保持一致。如果少于多数人执行这些规则，那么死锁仍然可能发生，并且取决于对有问题的块的第一次观察，这并不比当前情况更糟。

如果客户只执行部分规则，只要每个更高级别的规则也执行，那么情况不会比今天更糟。

## 安全注意事项
参与网络的恶意和有动机的攻击者可以通过精心设计的块生产来迫使链停止。使用完全确定性的选择规则，停止的机会就会减少。攻击者仍然有相同的机会用相同高度的多个块淹没网络。基于最低哈希的确定性规则减少了这种泛洪攻击的影响。恶意验证者可以利用此确定性规则来生成替换块。这种攻击存在于当前的实现中，但确定性哈希规则使这种替换更有可能发生。然而，目前这种攻击的影响似乎微不足道。

## 参考
[https://eips.ethereum.org/EIPS/eip-3436](https://eips.ethereum.org/EIPS/eip-3436)

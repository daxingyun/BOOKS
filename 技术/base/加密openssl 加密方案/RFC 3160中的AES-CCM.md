# RFC 3160 中的 AES-CCM
## 1 介绍
CCM 对明文数据(记为 m，其长度记为 l(m)) 进行分组加密和认证，处理结果同时包括密文和认证字段，CCM 专门用于数据块大小为 128 位的分组加密算法，如 AES
## 2 模式规范
CCM 有 2 个参数选项

- M 

	输出的认证字段长度(单位：字节)，取值范围：4, 6, 8, 10, 12, 14, 16
- L 
	
	表示 l(m) 值的字节数( l(m) < 2^(8L) )，取值范围：2-8

将 M 和 L 转换为 M' 和 L' (以便容纳在一个字节中)，转换关系如下

名称|描述|大小|Encoding
---|---|---|---|---|
 M' |认证字段中的八位字节数|3bits | (M-2)/2
 L'|长度字段中的八位字节数|3 bits| L-1

CCMP 协议规定：M = 8 L = 2, 即 m 最长为 65535 字节，认证字段为 8 字节

### 2.1 CCM 加密输入参数
1. 分组密钥 K
2. 随机数 nonce  N，15-L 字节长，在 K 的周期过程中要确保 N 不被重复使用
3. 消息 m ，由 `l(m)` 个 8位的字符串组成(128 位)，其中 `0<= l(m) < 2 ^ (8L)` 。长度限制确保 `l(m)` 可以在 L 个八位字节的字段中编码。 
4.  附加认证数据 A，由 l(A) 个8位组成，其中 `0 <= l(a) < 2^64.` 用于数据的完整性校验（不参与加密运算），通常用于认证报文头的明文字段或对消息理解有影响的上下文。如果不想认证的用户可以提供长度为0的字符串代替

输入参数总结

名称|描述|大小|
---|---|---|---|---|
K|密钥|取决于分组长度,AES 128
N|Nonce/随机数/IV|15-L 8位
m|明文，认证和加密的数据|l(m) 8位 
A|附加认证数据|l(a) 8位

### 2.2 生成认证字段步骤
1. 计算认证字段 T，使用 CBC-MAC 算法，该算法涉及输入分组,首先定义序列 `B_0,B_1, ..., B_n`并将算法应用于这些数据块
	- 第一个数据分组 B_0 构成如下

	   Octet Number |内容
	   ---|---|---|---|---|
	   0|Flags (第一个字节)
	   1 ... 15-L|Nonce N(第15-L 字节)
	   16-L... 15|l(m)(第L字节 - L 的值见 Flags 字节)
	   
	- 分组 B_0 中的首字节 Flags 构成

			Flags = 64*Adata + 8*M' + L'
	
		Octet Number |内容
	  	 ---|---|---|---|---|
		7| 预留位 (永远是0)
      		6| 附加认证数据(Adata),如果 Bit6(Adata 位)=0，表示要生成附加认证数据 a，否则表示没有
      		5 ... 3| M' `(1--7) = (M-2)/2  (M:4--16)`
      		2 ... 0 | L' `(1--7) = L-1      (L:2--8)`
      		
      		
			   B_0 构成如下
			   长度   1      15-L           L
			   +----+-----+-----------+------------+
			   |字节 |  0  | 1 .. 15-L | 16-L .. 15 |
			   +----+-----+-----------+------------+
			   |内容 |Flags|  Nonce N  |  m 的长度  |
			   +----+-----+-----------+------------+
			       /      \                  ^
			      /        \                 |
			     /          \     L -- m 的长度表示范围
			    /            \     (L 越大，m 可以越长)
			   / Flags 展开后  \              |
			   +----+-+-----+-+-+-+-+-+-+    |L'(L) 决定
			   |位  |7|  6  |5|4|3|2|1|0|    |Nonce 的长度
			   +----+-+-----+-+-+-+-+-+-+    |
			   |内容 |0|Adata| M'  | L'  | ---+
			   +----+-+-----+-+-+-+-+-+-+
	- 如果 Bit6(Adata 位)=0，表示要生成附加认证数据 a，否则表示没有
	- 生成附加认证数据 A，需要构造认证数据块(一个或多个)，数据块编码如下
	- 

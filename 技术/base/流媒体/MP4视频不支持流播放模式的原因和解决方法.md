# MP4 视频不支持流播放模式的原因和解决方法
## 什么是 mp4
MP4 是一种描述较为全面的容器格式，被认为可以在其中嵌入任何形式的数据，各种编码的视频、音频等都不在话下，常见的大部分的 MP4 文件存放的 AVC(H.264) 或 MPEG-4(Part 2) 编码的视频和 AAC 编码的音频。

MP4 格式的官方文件后缀名是“.mp4”，还有其他的以 mp4 为基础进行的扩展或者是阉割版的格式，如：M4V, 3GP, F4V 等。

MP4 是由一个个 “Box” 组成的，大 Box 中存放小 Box，一级嵌套一级来存放媒体信息。

关于Box的几个概念：

- MP4 文件由许多个 Box 与 FullBox 组成。
- 每个 Box 由 Header 和 Data 两部分组成。
- FullBox 是 Box 的扩展，其在 Box 结构的基础上，在 Header 中增加8位 version 标志和24的 flags 标志。
- Header 包含了整个 Box 的长度的大小（size）和类型（type）
	- 当 size 等于 0 时，这个 Box 是文件的最后一个 Box。
	- 当 size 等于 1 时，说明 Box 长度需要更多的位来描述，在后面会自定义一个 64 位的 largesize 用来描述 Box 的长度。当 type 等于 uuid 时，说明这个 Box 中的数据是用户自定义扩展类型。
- Data 为 Box 的实际数据，可以是纯数据，也可以是更多的子 Box。
- 当一个 Box 中 Data 是一系列的子 Box 时，这个 Box 又可以称为 Container（容器）Box。

MP4常用参考标准 Box [排列方式](https://github.com/renhui/Thinking-in-AV/tree/master/多媒体格式/MP4)。

![](./pic/MP4常用参考标准排列方式.png)



## 流媒体问题
最近做一个项目需要 web 支持 mp4 流媒体播放，但发现有的 mp4 视频可以支持流媒体播放(边下边看)，有的 mp4 视频必须要全部下完才可以播放。

查询网络发现，原来 mp4 文件中包含一些数据本身的元数据(数据长度、时间、编码等信息)，如果这个数据被放到了数据头，那么久支持流播放，如果放到了数据尾部，那么就必须全部下完才可以播放。

- 支持流播放视频

	![](./pic/mp4info-1.png)
- 不支持流播放视频

	![](./pic/mp4info-2.png)

## 支持 seek
`moov box` 在 `mdat box` 前边的 MP4 类型做网络点播，支持拖拽 seek 的话，需要把 `moov box` 挪到 `mdat box` 之前

## mp4 支持流播放后使用 m3u8 的意义
1. HTML5 直接支持 m3u8 协议。
2. m3u8 里面包括的多是视频块索引，可以通过网络状态自动切换码率。
3. m3u8 允许客户在进行播放时，从许多不同的备用源中下载视频块。
4. m3u8 是 HLS 协议的部分内容。是一种能够通过 http 报文就能够请求和访问了。MP4 如果要实现在线播放那么就需要 RTP 协议来实现。两种手段有比较大的区别。
5. 更高性能上能够将部分 m3u8 的播放块切块之后直接加载到服务器内存中，让客户端可以更快的得到数据。
6. m3u8 由于是采用切块技术，那么下载的播放文件就可以少很多，只有当前播放的部分。这一点用在在线直播上有很大优势。


## 参考
- [音视频开发知识库](https://github.com/renhui/Thinking-in-AV)

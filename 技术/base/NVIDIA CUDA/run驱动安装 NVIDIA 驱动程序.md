# 安装 NVIDIA 驱动程序-Prev Part I. 安装配置说明
## 在你开始之前
在开始安装之前，请退出 X 服务器并终止所有 OpenGL 应用程序（请注意，即使在 X 服务器停止后，某些 OpenGL 应用程序也可能仍然存在）。您还应该在系统上设置默认运行级别，使其引导至 VGA 控制台，而不是直接引导至 X。如果在安装过程中出现问题，这样做会更容易恢复。有关详细信息，请参阅[附录 I，新 Linux 用户](http://download.nvidia.com/XFree86/Linux-x86_64/470.86/README/newusertips.html)的提示。

如果您在设置为使用 Nouveau 驱动程序的系统上进行安装，那么您应该先禁用它，然后再尝试安装 NVIDIA 驱动程序。有关详细信息，请参阅问答 8.1，[“与 Nouveau 驱动程序的交互”](http://download.nvidia.com/XFree86/Linux-x86_64/470.86/README/commonproblems.html#nouveau)。
## 启动安装程序
下载文件 `NVIDIA-Linux-x86_64-470.86.run` 后，切换到包含下载文件的目录，并以 root 用户身份运行可执行文件：

    # cd yourdirectory
    # sh NVIDIA-Linux-x86_64-470.86.run
`.run` 文件是一个自解压档案。执行时，它会提取存档的内容并运行包含的 `nvidia-installer` 实用程序，该实用程序提供交互式界面来引导您完成安装。

`nvidia-installer` 也会将自己安装到 `/usr/bin/nvidia-installer`，稍后可能会使用它来卸载驱动程序、自动下载更新的驱动程序等。本章稍后将详细介绍该实用程序的使用。

您还可以为 `.run` 文件提供命令行选项。下面列出了一些更常见的选项。

常用 `.run` 选项

- `--info `

	打印有关 ` .run` 文件的嵌入信息并退出。
- `--check`

	检查存档的完整性并退出。

- `--extract-only`

	解压 `./NVIDIA-Linux-x86_64-470.86.run` 的内容，但不运行 `nvidia-installer`。
- `--help`

	打印常用命令行选项的使用信息并退出。
- `--advanced-options`

	打印常用命令行选项以及高级选项的使用信息，然后退出。
	
## 安装内核接口
NVIDIA 内核模块有一个内核接口层，必须为每个内核专门编译。 NVIDIA 将源代码分发到这个内核接口层。

当安装程序运行时，它将检查您的系统以获取所需的内核源并编译内核接口。 您必须安装内核的源代码才能进行编译。 在大多数系统上，这意味着您需要找到并安装正确的 `kernel-source、kernel-headers` 或 `kernel-devel` 包； 在某些发行版上，不需要额外的软件包。

编译正确的内核接口后，内核接口将与 NVIDIA 内核模块的闭源部分链接。 这要求您在系统上安装链接器。 链接器，通常是 `/usr/bin/ld`，是 binutils 包的一部分。 在安装 NVIDIA 驱动程序之前，您必须安装链接器。
## 向 DKMS 注册 NVIDIA 内核模块
安装程序将检查您的系统上是否存在 DKMS。如果找到 DKMS，您将可以选择向 DKMS 注册内核模块，并使用 DKMS 基础架构构建和安装内核模块。在大多数带有 DKMS 的系统上，DKMS 会在安装不同的 Linux 内核时自动重建已注册的内核模块。

如果 `nvidia-installer ` 无法通过 DKMS 安装内核模块，安装将中止并且不会安装内核模块。如果发生这种情况，应再次尝试安装，不使用 DKMS 选项。

请注意，304 版之前的驱动程序附带的 `nvidia-installer` 版本不与 DKMS 交互。如果您选择向 DKMS 注册 NVIDIA 内核模块，请确保在使用不支持 DKMS 的 `nvidia-installer` 版本安装旧驱动程序之前将该模块从 DKMS 数据库中删除；否则，模块源文件可能会在没有先取消注册模块的情况下被删除，可能会使 DKMS 数据库处于不一致的状态。在使用较旧的安装程序安装驱动程序之前运行 `nvidia-uninstall `将调用正确的 `dkms remove` 命令来清理安装。

由于缺乏可被 DKMS 等自动化流程使用的私钥的安全存储，因此无法将 DKMS 与 `nvidia-installer` 中内置的模块签名支持结合使用。
## 签署 NVIDIA 内核模块
某些内核可能要求内核模块由内核信任的密钥进行加密签名才能加载。特别是，许多发行版要求模块在加载到在启用了安全启动的 UEFI 系统上运行的内核中时进行签名。 `nvidia-installer` 支持在安装前对内核模块进行签名，以确保它可以在此类系统上加载。请注意，并非所有 UEFI 系统都启用了 Secure Boot，并且并非所有在 UEFI Secure Boot 系统上运行的内核都需要签名的内核模块，因此如果您不确定您的系统是否需要签名的内核模块，您可以尝试在不签名的情况下安装驱动程序内核模块，查看是否可以加载未签名的内核模块。

为了对内核模块进行签名，您将需要一个私有签名密钥，以及相应公钥的 X.509 证书。 X.509 证书必须被内核信任才能加载模块：我们建议在开始安装驱动程序之前确保签名密钥是信任的，以便可以立即使用新签名的模块。如果您还没有适合模块签名使用的密钥对，则必须生成一个。有关适用于模块签名的密钥类型以及如何生成它们的详细信息，请查阅您的发行版文档。`nvidia-installer` 可以在安装时为您生成一个密钥对，但最好在安装开始之前已经生成并受内核信任的密钥对。

准备好密钥对后，您可以在 `nvidia-installer` 中使用该密钥对，方法是使用 `--module-signing-secret-key` 和 `--module-signing-public-key` 在命令行上将密钥传递给安装程序选项。例如，可以通过运行以下命令以静默模式（即非交互方式）安装带有签名内核模块的驱动程序：

	 # sh ./NVIDIA-Linux-x86_64-470.86.run -s \
	--module-signing-secret-key=/path/to/signing.key \
	--module-signing-public-key=/path/to/signing.x509
在上面的示例中，`signing.key` 和 `signing.x509` 是一对私钥/公钥，并且公钥已经注册到内核的受信任模块签名密钥源之一中。

在启用了安全启动的 UEFI 系统上，`nvidia-installer` 将呈现一系列交互式提示，以指导用户完成模块签名过程。作为在命令行上设置关键路径的替代方法，可以交互地提供路径以响应提示。当针对在其配置中启用了 `CONFIG_MODULE_SIG_FORCE` 的内核构建 NVIDIA 内核模块时，或者如果安装程序在专家模式下运行，这些提示也会出现。

## 内核信任的关键来源
为了将内核模块加载到需要模块签名的内核中，模块必须由内核信任的密钥签名。内核可以利用多种资源来构建其可信密钥池。如果您已经生成了一个密钥对，但您的内核尚未信任它，您必须将您的公钥证书添加到受信任的密钥源，然后才能使用它来验证已签名内核模块的签名。这些可信来源包括：

- 嵌入到内核映像中的证书

	在设置了 `CONFIG_MODULE_SIG` 的内核上，用于对 in-tree 内核模块进行签名的公钥证书以及在构建时提供的任何其他模块签名证书都嵌入到内核映像中。由对应于嵌入式公钥证书的私钥签名的模块将被内核信任。

	由于密钥是在构建时嵌入的，因此添加新公钥的唯一方法是构建新内核。在启用了安全启动的 UEFI 系统上，内核映像将需要由引导加载程序信任的密钥进行签名，因此使用自定义嵌入式密钥构建自己的内核的用户应该有一个计划，以确保引导加载程序将加载新内核。
- 存储在 UEFI 固件数据库中的证书

	在带有 CONFIG_MODULE_SIG_UEFI 的内核上，除了嵌入到内核映像中的任何证书外，内核还可以使用存储在计算机 UEFI 固件的 db、KEK 或 PK 数据库中的证书来验证内核模块的签名，只要它们不是UEFI dbx 黑名单中。

	任何持有 Secure Boot PK 私钥或 KEK 列表中的任何密钥的用户都应该能够通过 `CONFIG_MODULE_SIG_UEFI` 添加可由内核使用的新密钥，并且任何可以物理访问计算机的用户都应该是能够删除任何现有的安全启动密钥，并安装他或她自己的密钥。有关如何管理 UEFI 安全启动密钥的详细信息，请参阅您基于 UEFI 的计算机系统的文档。
- 存储在补充密钥数据库中的证书

	一些发行版包含的实用程序允许在独立于内核的内置密钥列表和 UEFI 固件中的密钥列表的数据库中安全存储和管理加密密钥。一个突出的例子是某些版本的 shim 引导加载程序使用的 MOK（机器所有者密钥）数据库，以及相关的管理实用程序 mokutil 和 MokManager。

	这样的系统允许用户注册额外的密钥，而无需构建新内核或管理 UEFI 安全启动密钥。请查阅您的发行版的文档以获取有关此类补充密钥数据库是否可用以及如何管理其密钥的详细信息。

## 在 nvidia-installer 中生成签名密钥
如果现有密钥不可用，`nvidia-installer` 可以生成可用于模块签名的密钥。请注意，由新生成的密钥签名的模块在其密钥被信任之前不能加载到需要签名模块的内核中，并且当这样的模块安装在这样的系统上时，安装的驱动程序将不会立即可用，即使安装成功。

当` nvidia-installer` 生成密钥对并使用它来签署内核模块时，包含公钥的 X.509 证书将安装到磁盘上，以便可以将其添加到内核的受信任密钥源之一。 `nvidia-installer ` 将报告已安装证书的位置：记下此位置以及证书的 SHA1 指纹，以便在安装完成后注册证书并验证它是否正确。

默认情况下，`nvidia-installer` 将在模块签名后尝试使用 shred -u 安全地删除生成的私钥。这是为了防止密钥被利用来签署恶意内核模块，但这也意味着不能再次使用相同的密钥来安装不同的驱动程序，甚至不能在不同的内核上安装相同的驱动程序。 `nvidia-installer` 可以选择将私有签名密钥安装到磁盘，就像它对公共证书所做的那样，以便将来可以重用密钥对。

如果您选择安装私钥，请确保采取适当的预防措施以确保它不会被盗。您可能希望采取的一些预防措施示例：

- 防止任何人在没有物理访问计算机的情况下读取密钥

	通常，需要物理访问才能安装安全启动密钥，包括在标准 UEFI 密钥数据库之外管理的密钥，以防止远程破坏操作系统安全性的攻击者安装恶意启动代码。如果远程用户（甚至是根用户）可以使用受信任的密钥，那么攻击者就有可能在没有物理访问权限的情况下签署任意内核模块，从而降低系统的安全性。

	确保密钥对远程用户不可用的一种方法是将其保存在可移动存储介质上，该介质与计算机断开连接，除非对模块进行签名。
- 不要存储未加密的私钥

	加密私钥可以增加额外的安全层：除非首先可以成功解密，否则密钥对签名模块没有用处。确保不要将密钥的未加密副本存储在持久性存储中：使用易失性存储（例如 RAM 磁盘），或者在不使用时安全地删除任何未加密的密钥副本（例如，使用 shred 而不是 rm）。请注意，使用 shred 可能不足以完全清除某些存储设备中的数据，特别是某些类型的固态存储。

### 安装程序模块签名支持的替代方案
可以在需要签名模块的系统上加载 NVIDIA 内核模块，而无需使用安装程序的模块签名支持。根据您的特定用例，您可能会发现这些替代方案之一比使用 `nvidia-installer `对模块进行签名更合适：

- 禁用 UEFI 安全启动（如果适用）

	在某些内核上，仅当在启用了安全启动的 UEFI 系统上启动时才会强制执行签名模块的要求。此类内核的某些用户可能会发现禁用安全启动更方便；但是，请注意，这会使恶意用户更容易安装可能有害的引导代码、内核或内核模块，从而降低系统的安全性。
- 使用不需要签名模块的内核

	内核可以配置为不检查模块签名，或者检查模块签名，但无论如何都允许加载没有受信任签名的模块。安装以这种方式配置的内核将允许安装未签名的模块。请注意，在安全引导系统上，您仍然需要确保使用引导加载程序和/或引导固件信任的密钥对内核进行签名，并且不强制执行模块签名验证的内核可能比一个安全性稍差确实如此。
	
## 将预编译的内核接口添加到安装程序包
当 `nvidia-installer` 运行时，它会为目标内核搜索一个预编译的内核接口层：如果找到，则可以通过将预编译的接口与 `nv-kernel.o` 链接来生成完整的内核模块，而不需要在目标系统上编译内核接口。 `nvidia-installer` 包含一项功能，允许用户将预编译界面添加到安装程序包中。这在许多用例中都很有用；例如，一大群配置相似的计算机的管理员可以为这些计算机上运行的内核准备一个带有预编译接口的安装程序包，然后部署定制的安装程序，这将能够安装 NVIDIA 内核模块而无需安装内核开发头文件或安装在目标系统上的编译器。 （仍然需要链接器。）

要使用此功能，只需使用 `--add-this-kernel` 选项调用 `.run` 安装程序包；例如

	# sh ./NVIDIA-Linux-x86_64-470.86.run --add-this-kernel
这将解压 `NVIDIA-Linux-x86_64-470.86.run`，为当前运行的内核编译内核接口层（使用 `--kernel-source-path` 和 `--kernel-output-path` 选项指定目标内核，而不是当前运行一个），并创建一个新的安装程序包，其中添加了内核接口层。

如果与 `nvidia-installer` 中对模块签名的内置支持结合使用，则配置为需要可信签名才能加载内核模块的大型计算机组的管理员可能会发现此功能特别有用。要打包带有预编译内核接口层的 .run 文件，以及链接模块的分离模块签名，只需使用 -`-module-signing-secret-key` 和 `--module-signing-public-key` 选项以及 `--add-this-kernel` 选项。生成的包除了无需内核头文件或编译器即可在目标系统上安装之外，还有一个额外的好处是能够生成签名模块而无需访问安装目标系统上的私钥。请注意，仅当在目标系统上将预编译接口与 `nv-kernel.o` 链接的结果与在用于创建自定义安装程序的系统上链接这两个文件的结果完全相同时，分离的签名才有效.为确保最佳兼容性，包准备系统和安装目标系统上使用的链接器应该相同。
## 安装程序的其他功能
如果没有选项，`.run` 文件会在解压缩后执行安装程序。 安装程序可以作为过程中的一个单独步骤运行，也可以在以后运行以获取更新等。`nvidia-installer` 的一些更重要的命令行选项是：

`nvidia-installer ` 选项

 - `--uninstall`

	在安装过程中，安装程序将备份所有冲突文件并记录新文件的安装。 卸载选项撤消安装，将系统恢复到安装前的状态。

- `--ui=none`

	如果安装程序能够找到正确的 ncurses 库，它会使用基于 ncurses 的用户界面。 否则，它将退回到简单的命令行用户界面。 此选项禁用 ncurses 库的使用。	